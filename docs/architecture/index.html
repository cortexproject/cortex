<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.59.1"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Cortex Architecture | Cortex</title><meta property="og:title" content="Cortex Architecture"><meta property="og:description" content="Cortex consists of multiple horizontally scalable microservices. Each microservice uses the most appropriate technique for horizontal scaling; most are stateless and can handle requests for any users while some (namely the ingesters) are semi-stateful and depend on consistent hashing. This document provides a basic overview of Cortex&rsquo;s architecture.
The role of Prometheus Prometheus instances scrape samples from various targets and then push them to Cortex (using Prometheus&rsquo; remote write API)."><meta property="og:type" content="article"><meta property="og:url" content="/docs/architecture/"><meta property="article:modified_time" content="2019-11-26T19:47:52-05:00"><meta property="og:site_name" content="Cortex"><meta itemprop=name content="Cortex Architecture"><meta itemprop=description content="Cortex consists of multiple horizontally scalable microservices. Each microservice uses the most appropriate technique for horizontal scaling; most are stateless and can handle requests for any users while some (namely the ingesters) are semi-stateful and depend on consistent hashing. This document provides a basic overview of Cortex&rsquo;s architecture.
The role of Prometheus Prometheus instances scrape samples from various targets and then push them to Cortex (using Prometheus&rsquo; remote write API)."><meta itemprop=dateModified content="2019-11-26T19:47:52-05:00"><meta itemprop=wordCount content="1519"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Cortex Architecture"><meta name=twitter:description content="Cortex consists of multiple horizontally scalable microservices. Each microservice uses the most appropriate technique for horizontal scaling; most are stateless and can handle requests for any users while some (namely the ingesters) are semi-stateful and depend on consistent hashing. This document provides a basic overview of Cortex&rsquo;s architecture.
The role of Prometheus Prometheus instances scrape samples from various targets and then push them to Cortex (using Prometheus&rsquo; remote write API)."><link rel=preload href=/scss/main.min.2df0c895eea489407ba5512c0414f11ad925a8eee86f362e773d5b4f20bbb8b4.css as=style><link href=/scss/main.min.2df0c895eea489407ba5512c0414f11ad925a8eee86f362e773d5b4f20bbb8b4.css rel=stylesheet integrity><link href=/css/offline-search.css rel=stylesheet><script src=https://code.jquery.com/jquery-3.3.1.min.js integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin=anonymous></script><script src=https://unpkg.com/lunr@2.1.6/lunr.js></script><script src=/js/offline-search.js></script><title>Cortex Architecture | Cortex</title></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar navbar-nocover"><a id=cortex-logo class=navbar-brand href=/><span class=navbar-logo><svg xmlns="http://www.w3.org/2000/svg" role="img" viewBox="-17.92 -14.92 1191.84 462.84"><defs><style>.cls-1{fill:#fff}</style></defs><path d="M214.531 8.017C99.353 8.017 5.65 101.72 5.65 216.899S99.353 425.78 214.531 425.78s208.882-93.704 208.882-208.882S329.71 8.017 214.531 8.017zm0 408.558c-110.102.0-199.676-89.574-199.676-199.676S104.429 17.222 214.53 17.222 414.208 106.797 414.208 216.9 324.633 416.575 214.53 416.575z" class="cls-1"/><circle cx="327.452" cy="221.633" r="34.571" class="cls-1"/><circle cx="213.713" cy="353.584" r="34.571" class="cls-1"/><path d="M299.992 167.913l-59-56.05a34.578 34.578.0 1 0-4.343 4.34l57.828 54.937a60.158 60.158.0 0 0-27.168 49.123h-12.97l-23.456-67.02-26.055 64.718H175.73l-24.724 57.22-21.808-54.524-.063.025v-.586h-22.048a34.582 34.582.0 1 0-.275 6.138h18.005l25.97 64.925 28.977-67.06h29.207l21.51-53.424 19.503 55.725H267.5a60.173 60.173.0 0 0 25.202 44.11l-56.52 56.52 4.34 4.338 57.492-57.492a60.155 60.155.0 1 0 1.977-105.963zm81.481 53.515a54.02 54.02.0 1 1-54.022-54.02 54.083 54.083.0 0 1 54.022 54.02zm175.707 42.568q-8.797 8.178-24.405 8.177a34.858 34.858.0 0 1-17.095-3.965 33.188 33.188.0 0 1-11.643-10.529 46.374 46.374.0 0 1-6.566-14.99 71.134 71.134.0 0 1-2.105-17.341 86.99 86.99.0 0 1 1.982-18.706 46.804 46.804.0 0 1 6.565-15.98 34.028 34.028.0 0 1 12.263-11.149q7.675-4.21 19.077-4.212 13.38.0 21.306 6.69 7.927 6.689 10.405 18.829h21.803a50.76 50.76.0 0 0-5.946-19.696 44.06 44.06.0 0 0-12.015-13.75 49.842 49.842.0 0 0-16.848-8.051 77.44 77.44.0 0 0-20.44-2.601q-15.114.0-26.509 5.326a52.935 52.935.0 0 0-18.952 14.617 62.165 62.165.0 0 0-11.273 21.8 94.013 94.013.0 0 0-3.717 26.883 86.195 86.195.0 0 0 3.84 26.386 57.783 57.783.0 0 0 11.397 20.686 50.138 50.138.0 0 0 18.829 13.38 66.766 66.766.0 0 0 25.891 4.705q24.527.0 38.772-12.882 14.245-12.878 17.715-36.668h-21.556q-1.986 14.867-10.776 23.041zm157.44-87.828a56.338 56.338.0 0 0-19.447-14.244q-11.52-5.203-26.882-5.203-15.115.0-26.756 5.203a56.009 56.009.0 0 0-19.573 14.244 59.75 59.75.0 0 0-11.892 21.307 85.299 85.299.0 0 0-3.965 26.386 84.117 84.117.0 0 0 3.965 26.262 59.853 59.853.0 0 0 11.892 21.183 54.61 54.61.0 0 0 19.573 14.12q11.643 5.077 26.756 5.08 15.36.0 26.882-5.08a54.908 54.908.0 0 0 19.447-14.12 59.95 59.95.0 0 0 11.892-21.183 84.181 84.181.0 0 0 3.965-26.262 85.364 85.364.0 0 0-3.965-26.386 59.846 59.846.0 0 0-11.892-21.307zm-9.538 68.38a43.305 43.305.0 0 1-8.548 15.113 37.061 37.061.0 0 1-12.759 9.29 38.825 38.825.0 0 1-30.968.0 37.003 37.003.0 0 1-12.76-9.29 43.209 43.209.0 0 1-8.547-15.114 70.669 70.669.0 0 1 0-41.373 44.634 44.634.0 0 1 8.547-15.237 36.428 36.428.0 0 1 12.76-9.415 38.826 38.826.0 0 1 30.968.0 36.484 36.484.0 0 1 12.76 9.415 44.735 44.735.0 0 1 8.547 15.237 70.624 70.624.0 0 1 0 41.373zm81.141-80.89q-11.147 7.434-18.83 23.041h-.493v-27.005h-19.82V287.78h21.057v-56.984a87.528 87.528.0 0 1 2.478-21.924 41.993 41.993.0 0 1 7.93-16.228 33.951 33.951.0 0 1 14.368-10.158q8.919-3.468 21.555-3.468V156.72q-17.097-.493-28.245 6.937zm80.761-42.366h-21.06v38.402h-21.8v18.581h21.8v81.51a48.668 48.668.0 0 0 1.734 14.37 17.432 17.432.0 0 0 5.326 8.423 20.57 20.57.0 0 0 9.415 4.088 75.59 75.59.0 0 0 13.999 1.115h16.104v-18.582h-9.664a70.335 70.335.0 0 1-8.05-.37 10.361 10.361.0 0 1-4.833-1.611 6.108 6.108.0 0 1-2.354-3.469 23.006 23.006.0 0 1-.617-5.946v-79.528h25.518v-18.581h-25.518zm148.522 60.452a56.135 56.135.0 0 0-18.085-17.962q-11.276-7.063-28.367-7.06a58.263 58.263.0 0 0-24.155 4.953 56.796 56.796.0 0 0-19.079 13.875 63.949 63.949.0 0 0-12.51 21.058 77.064 77.064.0 0 0-4.461 26.758 102.521 102.521.0 0 0 4.338 27.004 58.87 58.87.0 0 0 11.519 21.307 52.43 52.43.0 0 0 18.953 13.873q11.272 4.954 26.632 4.955 21.8.0 36.173-10.901 14.364-10.898 18.58-32.455h-20.81q-2.73 12.635-11.272 18.829-8.549 6.198-21.927 6.195a43.577 43.577.0 0 1-18.085-3.468 35.417 35.417.0 0 1-12.636-9.291 36.127 36.127.0 0 1-7.184-13.38 50.746 50.746.0 0 1-1.981-15.98h95.879a102.07 102.07.0 0 0-2.107-24.526 71.064 71.064.0 0 0-9.415-23.784zm-84.357 29.73a43.81 43.81.0 0 1 3.219-13.999 37.354 37.354.0 0 1 7.433-11.52 34.013 34.013.0 0 1 11.272-7.803 36.694 36.694.0 0 1 14.74-2.85 36.062 36.062.0 0 1 14.494 2.85 36.492 36.492.0 0 1 11.398 7.68 36.107 36.107.0 0 1 7.68 11.52 43.253 43.253.0 0 1 3.345 14.122zm170.95 7.184 44.1-58.964h-25.271l-31.961 44.843-30.721-44.843h-27.006l44.595 60.698-48.063 67.389h25.518l35.677-53.019 35.676 53.019h27.006l-49.55-69.123z" class="cls-1"/></svg></span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/docs/><span class=active>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs/changelog/><span>Changelog</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a href=https://twitter.com/cortexmetrics class="nav-link active"><span class=active><i class="fab fa-fw fa-twitter"></i>Twitter</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a href=https://github.com/cortexproject class="nav-link active"><span class=active><i class="fab fa-fw fa-github"></i>Github</span></a></li></ul></div><div class="navbar-nav d-none d-md-block"><div id=search-nav-container><input type=search id=search-input autocomplete=off class="form-control td-search-input" placeholder="&#xf002 Search this site…" autocomplete=on><div id=search-results class=container></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><nav class="collapse td-sidebar-nav pt-2 pl-4" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/ class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__section">Documentation</a></li><ul><li class="collapse show" id=docs><a class="td-sidebar-link td-sidebar-link__page" id=m-docs-getting-started href=/docs/getting-started/>Getting Started</a>
<a class="td-sidebar-link td-sidebar-link__page active" id=m-docs-architecture href=/docs/architecture/>Cortex Architecture</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docs-apis href=/docs/apis/>Cortex APIs</a><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/guides/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Guides</a></li><ul><li class=collapse id=docs-guides><a class="td-sidebar-link td-sidebar-link__page" id=m-docs-guides-running-in-production href=/docs/guides/running-in-production/>Running Cortex in Production</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docs-guides-auth href=/docs/guides/auth/>Authentication and Authorisation</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docs-guides-aws href=/docs/guides/aws/>Running Cortex at AWS</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docs-guides-ha-pair-handling href=/docs/guides/ha-pair-handling/>Config for sending HA Pairs data to Cortex</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docs-guides-ingester-handover href=/docs/guides/ingester-handover/>Ingester Hand-over</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docs-guides-tracing href=/docs/guides/tracing/>Tracing</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/configuration/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Configuration</a></li><ul><li class=collapse id=docs-configuration><a class="td-sidebar-link td-sidebar-link__page" id=m-docs-configuration-arguments href=/docs/configuration/arguments/>Cortex Arguments Explained</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docs-configuration-prometheus-frontend href=/docs/configuration/prometheus-frontend/>Prometheus Frontend</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docs-configuration-single-process-config href=/docs/configuration/single-process-config/>Single-process</a></li></ul></ul><a class="td-sidebar-link td-sidebar-link__page" id=m-docs-changelog href=/docs/changelog/>Changelog</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docs-code-of-conduct href=/docs/code-of-conduct/>Code of Conduct</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docs-contributing href=/docs/contributing/>Contributing</a></li></ul></ul></nav></div></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/cortexproject/cortex/edit/master/content/en/docs/architecture.md target=_blank><i class="fa fa-edit fa-fw"></i>Edit this page</a>
<a href="https://github.com/cortexproject/cortex/issues/new?title=Cortex%20Architecture" target=_blank><i class="fab fa-github fa-fw"></i>Create documentation issue</a>
<a href=https://github.com/cortexproject/cortex/issues/new target=_blank><i class="fas fa-tasks fa-fw"></i>Create project issue</a></div><nav id=TableOfContents><ul><li><ul><li><a href=#the-role-of-prometheus>The role of Prometheus</a></li><li><a href=#services>Services</a><ul><li><a href=#distributor>Distributor</a><ul><li><a href=#hashing>Hashing</a></li><li><a href=#the-hash-ring>The hash ring</a></li><li><a href=#quorum-consistency>Quorum consistency</a></li><li><a href=#load-balancing-across-distributors>Load balancing across distributors</a></li></ul></li><li><a href=#ingester>Ingester</a><ul><li><a href=#write-de-amplification>Write de-amplification</a></li></ul></li><li><a href=#ruler>Ruler</a></li><li><a href=#alertmanager>AlertManager</a></li><li><a href=#query-frontend>Query frontend</a><ul><li><a href=#queueing>Queueing</a></li><li><a href=#splitting>Splitting</a></li><li><a href=#caching>Caching</a></li><li><a href=#parallelism>Parallelism</a></li></ul></li><li><a href=#querier>Querier</a></li></ul></li><li><a href=#chunk-store>Chunk store</a></li></ul></li></ul></nav></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class="d-none d-md-block d-print-none"><ol class="breadcrumb spb-1"><li class=breadcrumb-item><a href=/docs/>Documentation</a></li><li class="breadcrumb-item active" aria-current=page><a href=/docs/architecture/>Cortex Architecture</a></li></ol></nav><div class=td-content><h1>Cortex Architecture</h1><p>Cortex consists of multiple horizontally scalable microservices. Each microservice uses the most appropriate technique for horizontal scaling; most are stateless and can handle requests for any users while some (namely the <a href=#ingester>ingesters</a>) are semi-stateful and depend on consistent hashing. This document provides a basic overview of Cortex&rsquo;s architecture.</p><p align=center><img src=/images/architecture.png alt="Cortex Architecture"></p><h2 id=the-role-of-prometheus>The role of Prometheus</h2><p>Prometheus instances scrape samples from various targets and then push them to Cortex (using Prometheus&rsquo; <a href=https://prometheus.io/docs/prometheus/latest/storage/#remote-storage-integrations>remote write API</a>). That remote write API emits batched <a href=https://google.github.io/snappy/>Snappy</a>-compressed <a href=https://developers.google.com/protocol-buffers/>Protocol Buffer</a> messages inside the body of an HTTP <code>PUT</code> request.</p><p>Cortex requires that each HTTP request bear a header specifying a tenant ID for the request. Request authentication and authorization are handled by an external reverse proxy.</p><p>Incoming samples (writes from Prometheus) are handled by the <a href=#distributor>distributor</a> while incoming reads (PromQL queries) are handled by the <a href=#query-frontend>query frontend</a>.</p><h2 id=services>Services</h2><p>Cortex has a service-based architecture, in which the overall system is split up into a variety of components that perform specific tasks and run separately (and potentially in parallel).</p><p>Cortex is, for the most part, a shared-nothing system. Each layer of the system can run multiple instances of each component and they don&rsquo;t coordinate or communicate with each other within that layer.</p><h3 id=distributor>Distributor</h3><p>The <strong>distributor</strong> service is responsible for handling samples written by Prometheus. It&rsquo;s essentially the &ldquo;first stop&rdquo; in the write path for Prometheus samples. Once the distributor receives samples from Prometheus, it splits them into batches and then sends them to multiple <a href=#ingester>ingesters</a> in parallel.</p><p>Distributors communicate with ingesters via <a href=https://grpc.io>gRPC</a>. They are stateless and can be scaled up and down as needed.</p><p>If the HA Tracker is enabled, the Distributor will deduplicate incoming samples that contain both a cluster and replica label. It talks to a KVStore to store state about which replica per cluster it&rsquo;s accepting samples from for a given user ID. Samples with one or neither of these labels will be accepted by default.</p><h4 id=hashing>Hashing</h4><p>Distributors use consistent hashing, in conjunction with the (configurable) replication factor, to determine <em>which</em> instances of the ingester service receive each sample.</p><p>The hash itself is based on one of two schemes:</p><ol><li>The metric name and tenant ID</li><li>All the series labels and tenant ID</li></ol><p>The trade-off associated with the latter is that writes are more balanced but they must involve every ingester in each query.</p><blockquote><p>This hashing scheme was originally chosen to reduce the number of required ingesters on the query path. The trade-off, however, is that the write load on the ingesters is less even.</p></blockquote><h4 id=the-hash-ring>The hash ring</h4><p>A consistent hash ring is stored in <a href=https://www.consul.io/>Consul</a> as a single key-value pair, with the ring data structure also encoded as a <a href=https://developers.google.com/protocol-buffers/>Protobuf</a> message. The consistent hash ring consists of a list of tokens and ingesters. Hashed values are looked up in the ring; the replication set is built for the closest unique ingesters by token. One of the benefits of this system is that adding and remove ingesters results in only 1/<em>N</em> of the series being moved (where <em>N</em> is the number of ingesters).</p><h4 id=quorum-consistency>Quorum consistency</h4><p>All distributors share access to the same hash ring, which means that write requests can be sent to any distributor.</p><p>To ensure consistent query results, Cortex uses <a href=https://www.allthingsdistributed.com/files/amazon-dynamo-sosp2007.pdf>Dynamo</a>-style quorum consistency on reads and writes. This means that the distributor will wait for a positive response of at least one half plus one of the ingesters to send the sample to before responding to the user.</p><h4 id=load-balancing-across-distributors>Load balancing across distributors</h4><p>We recommend randomly load balancing write requests across distributor instances, ideally by running the distributors as a Kubernetes <a href=https://kubernetes.io/docs/concepts/services-networking/service/>Service</a>.</p><h3 id=ingester>Ingester</h3><p>The <strong>ingester</strong> service is responsible for writing sample data to long-term storage backends (DynamoDB, S3, Cassandra, etc.).</p><p>Samples from each timeseries are built up in &ldquo;chunks&rdquo; in memory inside each ingester, then flushed to the <a href=#chunk-store>chunk store</a>. By default each chunk is up to 12 hours long.</p><p>If an ingester process crashes or exits abruptly, all the data that has not yet been flushed will be lost. Cortex is usually configured to hold multiple (typically 3) replicas of each timeseries to mitigate this risk.</p><p>A <a href=/docs/guides/ingester-handover/>hand-over process</a> manages the state when ingesters are added, removed or replaced.</p><h4 id=write-de-amplification>Write de-amplification</h4><p>Ingesters store the last 12 hours worth of samples in order to perform <strong>write de-amplification</strong>, i.e. batching and compressing samples for the same series and flushing them out to the <a href=#chunk-store>chunk store</a>. Under normal operations, there should be <em>many</em> orders of magnitude fewer operations per second (OPS) worth of writes to the chunk store than to the ingesters.</p><p>Write de-amplification is the main source of Cortex&rsquo;s low total cost of ownership (TCO).</p><h3 id=ruler>Ruler</h3><p>Ruler executes PromQL queries for Recording Rules and Alerts. Ruler
is configured from a database, so that different rules can be set for
each tenant.</p><p>All the rules for one instance are executed as a group, then
rescheduled to be executed again 15 seconds later. Execution is done
by a &lsquo;worker&rsquo; running on a goroutine - if you don&rsquo;t have enough
workers then the ruler will lag behind.</p><p>Ruler can be scaled horizontally.</p><h3 id=alertmanager>AlertManager</h3><p>AlertManager is responsible for accepting alert notifications from
Ruler, grouping them, and passing on to a notification channel such as
email, PagerDuty, etc.</p><p>Like the Ruler, AlertManager is configured per-tenant in a database.</p><p><a href=https://prometheus.io/docs/alerting/alertmanager/>Upstream Docs</a>.</p><h3 id=query-frontend>Query frontend</h3><p>The <strong>query frontend</strong> is an optional service that accepts HTTP requests, queues them by tenant ID, and retries in case of errors.</p><blockquote><p>The query frontend is completely optional; you can use queriers directly. To use the query frontend, direct incoming authenticated reads at them and set the <code>-querier.frontend-address</code> flag on the queriers.</p></blockquote><h4 id=queueing>Queueing</h4><p>Queuing performs a number of functions for the query frontend:</p><ul><li>It ensures that large queries that cause an out-of-memory (OOM) error in the querier will be retried. This allows administrators to under-provision memory for queries, or optimistically run more small queries in parallel, which helps to reduce TCO.</li><li>It prevents multiple large requests from being convoyed on a single querier by distributing them first-in/first-out (FIFO) across all queriers.</li><li>It prevents a single tenant from denial-of-service-ing (DoSing) other tenants by fairly scheduling queries between tenants.</li></ul><h4 id=splitting>Splitting</h4><p>The query frontend splits multi-day queries into multiple single-day queries, executing these queries in parallel on downstream queriers and stitching the results back together again. This prevents large, multi-day queries from OOMing a single querier and helps them execute faster.</p><h4 id=caching>Caching</h4><p>The query frontend caches query results and reuses them on subsequent queries. If the cached results are incomplete, the query frontend calculates the required subqueries and executes them in parallel on downstream queriers. The query frontend can optionally align queries with their step parameter to improve the cacheability of the query results.</p><h4 id=parallelism>Parallelism</h4><p>The query frontend job accepts gRPC streaming requests from the queriers, which then &ldquo;pull&rdquo; requests from the frontend. For high availability it&rsquo;s recommended that you run multiple frontends; the queriers will connect to—and pull requests from—all of them. To reap the benefit of fair scheduling, it is recommended that you run fewer frontends than queriers. Two should suffice in most cases.</p><h3 id=querier>Querier</h3><p>The <strong>querier</strong> service handles the actual <a href=https://prometheus.io/docs/prometheus/latest/querying/basics/>PromQL</a> evaluation of samples stored in long-term storage.</p><p>It embeds the chunk store client code for fetching data from long-term storage and communicates with <a href=#ingester>ingesters</a> for more recent data.</p><h2 id=chunk-store>Chunk store</h2><p>The <strong>chunk store</strong> is Cortex&rsquo;s long-term data store, designed to support interactive querying and sustained writing without the need for background maintenance tasks. It consists of:</p><ul><li>An index for the chunks. This index can be backed by <a href=https://aws.amazon.com/dynamodb>DynamoDB from Amazon Web Services</a>, <a href=https://cloud.google.com/bigtable>Bigtable from Google Cloud Platform</a>, <a href=https://cassandra.apache.org>Apache Cassandra</a>.</li><li>A key-value (KV) store for the chunk data itself, which can be DynamoDB, Bigtable, Cassandra again, or an object store such as <a href=https://aws.amazon.com/s3>Amazon S3</a></li></ul><blockquote><p>Unlike the other core components of Cortex, the chunk store is not a separate service, job, or process, but rather a library embedded in the three services that need to access Cortex data: the <a href=#ingester>ingester</a>, <a href=#querier>querier</a>, and <a href=#ruler>ruler</a>.</p></blockquote><p>The chunk store relies on a unified interface to the &ldquo;<a href=https://en.wikipedia.org/wiki/NoSQL>NoSQL</a>&rdquo; stores—DynamoDB, Bigtable, and Cassandra—that can be used to back the chunk store index. This interface assumes that the index is a collection of entries keyed by:</p><ul><li>A <strong>hash key</strong>. This is required for <em>all</em> reads and writes.</li><li>A <strong>range key</strong>. This is required for writes and can be omitted for reads, which can be queried by prefix or range.</li></ul><p>The interface works somewhat differently across the supported databases:</p><ul><li>DynamoDB supports range and hash keys natively. Index entries are thus modelled directly as DynamoDB entries, with the hash key as the distribution key and the range as the range key.</li><li>For Bigtable and Cassandra, index entries are modelled as individual column values. The hash key becomes the row key and the range key becomes the column key.</li></ul><p>A set of schemas are used to map the matchers and label sets used on reads and writes to the chunk store into appropriate operations on the index. Schemas have been added as Cortex has evolved, mainly in an attempt to better load balance writes and improve query performance.</p><blockquote><p>The current schema recommendation is the <strong>v10 schema</strong>. v11 schema is an experimental schema.</p></blockquote><div class="text-muted mt-5 pt-3 border-top">Last modified November 26, 2019: <a href=https://github.com/cortexproject/cortex/commit/53098addb36d2e3e58e05b257d8603e0731aad4c>Review feedback and center homepage logo. (53098add)</a></div></div></main></div></div><footer class="row td-box td-box--dark td-box--gradient td-box--height-auto text-white p-5"><div class="col-12 col-sm-4 pb-5 pb-sm-0"><img src=/images/cortex-stacked-white.png width=75px class="img-fluid float-left"></div><div class="col-12 col-sm-4 pb-5 pb-sm-0"><h6 class=font-weight-bold>Community</h6><ul class=list-unstyled><li><a href=https://slack.cncf.io class="text-reset text-white"><i class="fab fa-fw fa-slack"></i>Slack</a></li><li><a href=https://github.com/cortexproject/cortex class="text-reset text-white"><i class="fab fa-fw fa-github"></i>GitHub</a></li><li><a href=https://twitter.com/cortexmetrics class="text-reset text-white"><i class="fab fa-fw fa-twitter"></i>Twitter</a></li></ul></div><div class="col-12 col-sm-4"><h6 class=font-weight-bold>About</h6><p>Cortex is an OSS licensed project as Apache License 2.0</p></div></footer></div><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script><script src=/js/main.min.29b0315468c00226fa6f4556a9cebc0ac4fe1ce1457a01b22c0a06b329877383.js integrity="sha256-KbAxVGjAAib6b0VWqc68CsT&#43;HOFFegGyLAoGsymHc4M=" crossorigin=anonymous></script></body></html>