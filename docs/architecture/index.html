<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.101.0"><meta name=robots content="index, follow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Cortex Architecture | Cortex</title><meta name=description content="Cortex consists of multiple horizontally scalable microservices. Each microservice uses the most appropriate technique for horizontal scaling; most …"><meta property="og:title" content="Cortex Architecture"><meta property="og:description" content="Cortex consists of multiple horizontally scalable microservices. Each microservice uses the most appropriate technique for horizontal scaling; most are stateless and can handle requests for any users while some (namely the ingesters) are semi-stateful and depend on consistent hashing. This document provides a basic overview of Cortex&rsquo;s architecture.
The following diagram does not include all the Cortex services, but does represent a typical deployment topology.
The role of Prometheus Prometheus instances scrape samples from various targets and then push them to Cortex (using Prometheus&rsquo; remote write API)."><meta property="og:type" content="article"><meta property="og:url" content="/docs/architecture/"><meta property="og:image" content="/images/logo-twitter-card.jpg"><meta property="article:section" content="docs"><meta property="og:site_name" content="Cortex"><meta itemprop=name content="Cortex Architecture"><meta itemprop=description content="Cortex consists of multiple horizontally scalable microservices. Each microservice uses the most appropriate technique for horizontal scaling; most are stateless and can handle requests for any users while some (namely the ingesters) are semi-stateful and depend on consistent hashing. This document provides a basic overview of Cortex&rsquo;s architecture.
The following diagram does not include all the Cortex services, but does represent a typical deployment topology.
The role of Prometheus Prometheus instances scrape samples from various targets and then push them to Cortex (using Prometheus&rsquo; remote write API)."><meta itemprop=wordCount content="2850"><meta itemprop=image content="/images/logo-twitter-card.jpg"><meta itemprop=keywords content><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/images/logo-twitter-card.jpg"><meta name=twitter:title content="Cortex Architecture"><meta name=twitter:description content="Cortex consists of multiple horizontally scalable microservices. Each microservice uses the most appropriate technique for horizontal scaling; most are stateless and can handle requests for any users while some (namely the ingesters) are semi-stateful and depend on consistent hashing. This document provides a basic overview of Cortex&rsquo;s architecture.
The following diagram does not include all the Cortex services, but does represent a typical deployment topology.
The role of Prometheus Prometheus instances scrape samples from various targets and then push them to Cortex (using Prometheus&rsquo; remote write API)."><link rel=preload href=/scss/main.min.b2327889d9640582f368772c608732b32a6fa5b2b0c58b3d3c1d139029933f80.css as=style><link href=/scss/main.min.b2327889d9640582f368772c608732b32a6fa5b2b0c58b3d3c1d139029933f80.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SRR0DSREGX"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-SRR0DSREGX",{anonymize_ip:!1})}</script></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar navbar-nocover"><a id=cortex-logo class=navbar-brand href=/><span class=navbar-logo><svg xmlns="http://www.w3.org/2000/svg" role="img" viewBox="-17.92 -14.92 1191.84 462.84"><defs><style>.cls-1{fill:#fff}</style></defs><path d="M214.531 8.017C99.353 8.017 5.65 101.72 5.65 216.899S99.353 425.78 214.531 425.78s208.882-93.704 208.882-208.882S329.71 8.017 214.531 8.017zm0 408.558c-110.102.0-199.676-89.574-199.676-199.676S104.429 17.222 214.53 17.222 414.208 106.797 414.208 216.9 324.633 416.575 214.53 416.575z" class="cls-1"/><circle cx="327.452" cy="221.633" r="34.571" class="cls-1"/><circle cx="213.713" cy="353.584" r="34.571" class="cls-1"/><path d="M299.992 167.913l-59-56.05a34.578 34.578.0 10-4.343 4.34l57.828 54.937a60.158 60.158.0 00-27.168 49.123h-12.97l-23.456-67.02-26.055 64.718H175.73l-24.724 57.22-21.808-54.524-.063.025v-.586h-22.048a34.582 34.582.0 10-.275 6.138h18.005l25.97 64.925 28.977-67.06h29.207l21.51-53.424 19.503 55.725H267.5a60.173 60.173.0 0025.202 44.11l-56.52 56.52 4.34 4.338 57.492-57.492a60.155 60.155.0 101.977-105.963zm81.481 53.515a54.02 54.02.0 11-54.022-54.02 54.083 54.083.0 0154.022 54.02zm175.707 42.568q-8.797 8.178-24.405 8.177a34.858 34.858.0 01-17.095-3.965 33.188 33.188.0 01-11.643-10.529 46.374 46.374.0 01-6.566-14.99 71.134 71.134.0 01-2.105-17.341 86.99 86.99.0 011.982-18.706 46.804 46.804.0 016.565-15.98 34.028 34.028.0 0112.263-11.149q7.675-4.21 19.077-4.212 13.38.0 21.306 6.69 7.927 6.689 10.405 18.829h21.803a50.76 50.76.0 00-5.946-19.696 44.06 44.06.0 00-12.015-13.75 49.842 49.842.0 00-16.848-8.051 77.44 77.44.0 00-20.44-2.601q-15.114.0-26.509 5.326a52.935 52.935.0 00-18.952 14.617 62.165 62.165.0 00-11.273 21.8 94.013 94.013.0 00-3.717 26.883 86.195 86.195.0 003.84 26.386 57.783 57.783.0 0011.397 20.686 50.138 50.138.0 0018.829 13.38 66.766 66.766.0 0025.891 4.705q24.527.0 38.772-12.882 14.245-12.878 17.715-36.668h-21.556q-1.986 14.867-10.776 23.041zm157.44-87.828a56.338 56.338.0 00-19.447-14.244q-11.52-5.203-26.882-5.203-15.115.0-26.756 5.203a56.009 56.009.0 00-19.573 14.244 59.75 59.75.0 00-11.892 21.307 85.299 85.299.0 00-3.965 26.386 84.117 84.117.0 003.965 26.262 59.853 59.853.0 0011.892 21.183 54.61 54.61.0 0019.573 14.12q11.643 5.077 26.756 5.08 15.36.0 26.882-5.08a54.908 54.908.0 0019.447-14.12 59.95 59.95.0 0011.892-21.183 84.181 84.181.0 003.965-26.262 85.364 85.364.0 00-3.965-26.386 59.846 59.846.0 00-11.892-21.307zm-9.538 68.38a43.305 43.305.0 01-8.548 15.113 37.061 37.061.0 01-12.759 9.29 38.825 38.825.0 01-30.968.0 37.003 37.003.0 01-12.76-9.29 43.209 43.209.0 01-8.547-15.114 70.669 70.669.0 010-41.373 44.634 44.634.0 018.547-15.237 36.428 36.428.0 0112.76-9.415 38.826 38.826.0 0130.968.0 36.484 36.484.0 0112.76 9.415 44.735 44.735.0 018.547 15.237 70.624 70.624.0 010 41.373zm81.141-80.89q-11.147 7.434-18.83 23.041h-.493v-27.005h-19.82V287.78h21.057v-56.984a87.528 87.528.0 012.478-21.924 41.993 41.993.0 017.93-16.228 33.951 33.951.0 0114.368-10.158q8.919-3.468 21.555-3.468V156.72q-17.097-.493-28.245 6.937zm80.761-42.366h-21.06v38.402h-21.8v18.581h21.8v81.51a48.668 48.668.0 001.734 14.37 17.432 17.432.0 005.326 8.423 20.57 20.57.0 009.415 4.088 75.59 75.59.0 0013.999 1.115h16.104v-18.582h-9.664a70.335 70.335.0 01-8.05-.37 10.361 10.361.0 01-4.833-1.611 6.108 6.108.0 01-2.354-3.469 23.006 23.006.0 01-.617-5.946v-79.528h25.518v-18.581h-25.518zm148.522 60.452a56.135 56.135.0 00-18.085-17.962q-11.276-7.063-28.367-7.06a58.263 58.263.0 00-24.155 4.953A56.796 56.796.0 00925.82 175.55a63.949 63.949.0 00-12.51 21.058 77.064 77.064.0 00-4.461 26.758 102.521 102.521.0 004.338 27.004 58.87 58.87.0 0011.519 21.307 52.43 52.43.0 0018.953 13.873q11.272 4.954 26.632 4.955 21.8.0 36.173-10.901 14.364-10.898 18.58-32.455h-20.81q-2.73 12.635-11.272 18.829-8.549 6.198-21.927 6.195a43.577 43.577.0 01-18.085-3.468 35.417 35.417.0 01-12.636-9.291 36.127 36.127.0 01-7.184-13.38 50.746 50.746.0 01-1.981-15.98h95.879a102.07 102.07.0 00-2.107-24.526 71.064 71.064.0 00-9.415-23.784zm-84.357 29.73a43.81 43.81.0 013.219-13.999 37.354 37.354.0 017.433-11.52 34.013 34.013.0 0111.272-7.803 36.694 36.694.0 0114.74-2.85 36.062 36.062.0 0114.494 2.85 36.492 36.492.0 0111.398 7.68 36.107 36.107.0 017.68 11.52 43.253 43.253.0 013.345 14.122zm170.95 7.184 44.1-58.964h-25.271l-31.961 44.843-30.721-44.843h-27.006l44.595 60.698-48.063 67.389h25.518l35.677-53.019 35.676 53.019h27.006l-49.55-69.123z" class="cls-1"/></svg></span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/docs/><span class=active>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a href=https://twitter.com/cortexmetrics class="nav-link active"><span class=active><i class="fab fa-fw fa-twitter"></i> Twitter</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a href=https://github.com/cortexproject class="nav-link active"><span class=active><i class="fab fa-fw fa-github"></i> GitHub</span></a></li></ul></div><div class="navbar-nav d-none d-md-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.343df9a1efdde11da317dec9d1abb753.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><div id=content-mobile><form class="td-sidebar__search d-flex align-items-center"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.343df9a1efdde11da317dec9d1abb753.json data-offline-search-base-href=/ data-offline-search-max-results=10>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-section-nav aria-expanded=false aria-label="Toggle section navigation"></button></form></div><div id=content-desktop></div><nav class="collapse td-sidebar-nav" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docs-li><a href=/docs/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-docs><span>Documentation</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsgetting-started-li><a href=/docs/getting-started/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsgetting-started><span>Getting Started</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-docsarchitecture-li><a href=/docs/architecture/ title="Cortex Architecture" class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-docsarchitecture><span class=td-sidebar-nav-active-item>Architecture</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docsblocks-storage-li><a href=/docs/blocks-storage/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsblocks-storage><span>Blocks Storage</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsblocks-storagequerier-li><a href=/docs/blocks-storage/querier/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storagequerier><span>Querier</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsblocks-storagestore-gateway-li><a href=/docs/blocks-storage/store-gateway/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storagestore-gateway><span>Store-gateway</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsblocks-storagecompactor-li><a href=/docs/blocks-storage/compactor/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storagecompactor><span>Compactor</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsblocks-storageproduction-tips-li><a href=/docs/blocks-storage/production-tips/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storageproduction-tips><span>Production tips</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsblocks-storagebinary-index-header-li><a href=/docs/blocks-storage/binary-index-header/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storagebinary-index-header><span>Binary index-header</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsblocks-storagebucket-index-li><a href=/docs/blocks-storage/bucket-index/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storagebucket-index><span>Bucket Index</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsblocks-storagemigrate-cortex-cluster-from-chunks-to-blocks-li><a href=/docs/blocks-storage/migrate-cortex-cluster-from-chunks-to-blocks/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storagemigrate-cortex-cluster-from-chunks-to-blocks><span>Migrate Cortex cluster from chunks to blocks</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsblocks-storageconvert-long-term-storage-from-chunks-to-blocks-li><a href=/docs/blocks-storage/convert-long-term-storage-from-chunks-to-blocks/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storageconvert-long-term-storage-from-chunks-to-blocks><span>Convert long-term storage from chunks to blocks</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsblocks-storagemigrate-storage-from-thanos-and-prometheus-li><a href=/docs/blocks-storage/migrate-storage-from-thanos-and-prometheus/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storagemigrate-storage-from-thanos-and-prometheus><span>Migrate the storage from Thanos and Prometheus</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsblocks-storagelearn-more-li><a href=/docs/blocks-storage/learn-more/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storagelearn-more><span>Learn more</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docsconfiguration-li><a href=/docs/configuration/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsconfiguration><span>Configuration</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsconfigurationconfiguration-file-li><a href=/docs/configuration/configuration-file/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsconfigurationconfiguration-file><span>Configuration file</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsconfigurationarguments-li><a href=/docs/configuration/arguments/ title="Cortex Arguments" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsconfigurationarguments><span>Cortex Arguments Explained</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsconfigurationprometheus-frontend-li><a href=/docs/configuration/prometheus-frontend/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsconfigurationprometheus-frontend><span>Prometheus Frontend</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsconfigurationv1guarantees-li><a href=/docs/configuration/v1guarantees/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsconfigurationv1guarantees><span>v1.x Guarantees</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docsguides-li><a href=/docs/guides/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsguides><span>Guides</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidesrunning-cortex-on-kubernetes-li><a href=/docs/guides/running-cortex-on-kubernetes/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidesrunning-cortex-on-kubernetes><span>Running Cortex on Kubernetes</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidesgetting-started-with-gossiped-ring-li><a href=/docs/guides/getting-started-with-gossiped-ring/ title="Getting started with gossiped ring" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidesgetting-started-with-gossiped-ring><span>Getting started with a gossip ring cluster</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidesalertmanager-configuration-li><a href=/docs/guides/alertmanager-configuration/ title="Configuring Notification using Cortex Alertmanager" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidesalertmanager-configuration><span>Alertmanager configuration</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidesauth-li><a href=/docs/guides/auth/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidesauth><span>Authentication and Authorisation</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidescapacity-planning-li><a href=/docs/guides/capacity-planning/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidescapacity-planning><span>Capacity Planning</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidesruler-sharding-li><a href=/docs/guides/ruler-sharding/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidesruler-sharding><span>Config for horizontally scaling the Ruler</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidesha-pair-handling-li><a href=/docs/guides/ha-pair-handling/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidesha-pair-handling><span>Config for sending HA Pairs data to Cortex</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidesencryption-at-rest-li><a href=/docs/guides/encryption-at-rest/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidesencryption-at-rest><span>Encryption at Rest</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidesingesters-rolling-updates-li><a href=/docs/guides/ingesters-rolling-updates/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidesingesters-rolling-updates><span>Ingesters rolling updates</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidesingesters-scaling-up-and-down-li><a href=/docs/guides/ingesters-scaling-up-and-down/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidesingesters-scaling-up-and-down><span>Ingesters scaling up and down</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidesoverrides-exporter-li><a href=/docs/guides/overrides-exporter/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidesoverrides-exporter><span>Overrides Exporter</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidestls-li><a href=/docs/guides/tls/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidestls><span>Securing communication between Cortex components with TLS</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidessecurity-li><a href=/docs/guides/security/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidessecurity><span>Security</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidesshuffle-sharding-li><a href=/docs/guides/shuffle-sharding/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidesshuffle-sharding><span>Shuffle Sharding</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidestracing-li><a href=/docs/guides/tracing/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidestracing><span>Tracing</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguideszone-aware-replication-li><a href=/docs/guides/zone-aware-replication/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguideszone-aware-replication><span>Zone Aware Replication</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguideslimitations-li><a href=/docs/guides/limitations/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguideslimitations><span>Limitations</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidesglossary-li><a href=/docs/guides/glossary/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidesglossary><span>Glossary</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsapi-li><a href=/docs/api/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsapi><span>HTTP API</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docsoperations-li><a href=/docs/operations/ title="Operating Cortex" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsoperations><span>Operations</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsoperationsquery-auditor-li><a href=/docs/operations/query-auditor/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsoperationsquery-auditor><span>Query Auditor (tool)</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsoperationsquery-tee-li><a href=/docs/operations/query-tee/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsoperationsquery-tee><span>Query Tee (service)</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsoperationsrequests-mirroring-to-secondary-cluster-li><a href=/docs/operations/requests-mirroring-to-secondary-cluster/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsoperationsrequests-mirroring-to-secondary-cluster><span>Requests mirroring to secondary cluster</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsoperationsscaling-query-frontend-li><a href=/docs/operations/scaling-query-frontend/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsoperationsscaling-query-frontend><span>Scaling the Query Frontend</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docscase-studies-li><a href=/docs/case-studies/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docscase-studies><span>Case Studies</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docscase-studiesgojek-li><a href=/docs/case-studies/gojek/ title="How Gojek Is Leveraging Cortex to Keep Up with Its Ever-Growing Scale" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscase-studiesgojek><span>Gojek</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docscase-studiesrewe-digital-li><a href=/docs/case-studies/rewe-digital/ title="How Cortex helped REWE digital ensure stability while scaling services during the Covid-19 pandemic" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscase-studiesrewe-digital><span>REWE digital</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docscase-studiesbuoyant-cloud-li><a href=/docs/case-studies/buoyant-cloud/ title="Buoyant Cloud and Cortex: Standing on the shoulders of Linkerd and Prometheus" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscase-studiesbuoyant-cloud><span>Buoyant Cloud</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docsproposals-li><a href=/docs/proposals/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsproposals><span>Proposals</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsproposalsauth-gateway-li><a href=/docs/proposals/auth-gateway/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalsauth-gateway><span>Authentication Gateway</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsproposalsblocks-storage-bucket-index-li><a href=/docs/proposals/blocks-storage-bucket-index/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalsblocks-storage-bucket-index><span>Blocks storage bucket index</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsproposalsblocks-storage-sharding-li><a href=/docs/proposals/blocks-storage-sharding/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalsblocks-storage-sharding><span>Blocks storage sharding</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsproposalscross-tenant-query-federation-li><a href=/docs/proposals/cross-tenant-query-federation/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalscross-tenant-query-federation><span>Cross-Tenant Query Federation</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsproposalstenant-deletion-li><a href=/docs/proposals/tenant-deletion/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalstenant-deletion><span>Deletion of Tenant Data from Blocks Storage</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsproposalsdocumentation-versioning-li><a href=/docs/proposals/documentation-versioning/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalsdocumentation-versioning><span>Documentation Versioning</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsproposalsgeneralize-modules-li><a href=/docs/proposals/generalize-modules/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalsgeneralize-modules><span>Generalize Modules Service to make it extensible</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsproposalshttp-api-design-li><a href=/docs/proposals/http-api-design/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalshttp-api-design><span>HTTP API Design</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsproposalsingesters-migration-li><a href=/docs/proposals/ingesters-migration/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalsingesters-migration><span>Migrating ingesters from chunks to blocks and back.</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsproposalsparallel-compaction-li><a href=/docs/proposals/parallel-compaction/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalsparallel-compaction><span>Parallel Compaction by Time Interval</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsproposalstenant-retention-li><a href=/docs/proposals/tenant-retention/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalstenant-retention><span>Retention of Tenant Data from Blocks Storage</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsproposalsring-multikey-li><a href=/docs/proposals/ring-multikey/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalsring-multikey><span>Ring Multikey</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsproposalsruler-ha-li><a href=/docs/proposals/ruler-ha/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalsruler-ha><span>Ruler HA</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsproposalsruler-tenant-federation-li><a href=/docs/proposals/ruler-tenant-federation/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalsruler-tenant-federation><span>Ruler Tenant Federation</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsproposalsscalable-alertmanager-li><a href=/docs/proposals/scalable-alertmanager/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalsscalable-alertmanager><span>Scalable Alertmanager</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsproposalsscalable-query-frontend-li><a href=/docs/proposals/scalable-query-frontend/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalsscalable-query-frontend><span>Scalable Query Frontend</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsproposalsshuffle-sharding-and-zone-awareness-li><a href=/docs/proposals/shuffle-sharding-and-zone-awareness/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalsshuffle-sharding-and-zone-awareness><span>Shuffle sharding and zone awareness</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsproposalsshuffle-sharding-on-the-read-path-li><a href=/docs/proposals/shuffle-sharding-on-the-read-path/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalsshuffle-sharding-on-the-read-path><span>Shuffle sharding on the read path</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsproposalssupport-metadata-api-li><a href=/docs/proposals/support-metadata-api/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalssupport-metadata-api><span>Support metadata API</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsproposalsblock-storage-time-series-deletion-li><a href=/docs/proposals/block-storage-time-series-deletion/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalsblock-storage-time-series-deletion><span>Time Series Deletion from Blocks Storage</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsproposalstimeseries-partitioning-in-compactor-li><a href=/docs/proposals/timeseries-partitioning-in-compactor/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalstimeseries-partitioning-in-compactor><span>Timeseries Partitioning in Compactor</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docscontributing-li><a href=/docs/contributing/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docscontributing><span>Contributing</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docscontributinggovernance-li><a href=/docs/contributing/governance/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscontributinggovernance><span>Governance</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docscontributingdesign-patterns-and-code-conventions-li><a href=/docs/contributing/design-patterns-and-code-conventions/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscontributingdesign-patterns-and-code-conventions><span>Design patterns and Code conventions</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docscontributinghow-to-run-the-website-locally-li><a href=/docs/contributing/how-to-run-the-website-locally/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscontributinghow-to-run-the-website-locally><span>How to run the website locally</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docscontributinghow-to-upgrade-golang-version-li><a href=/docs/contributing/how-to-upgrade-golang-version/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscontributinghow-to-upgrade-golang-version><span>How to upgrade Golang version</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docscontributinghow-integration-tests-work-li><a href=/docs/contributing/how-integration-tests-work/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscontributinghow-integration-tests-work><span>How integration tests work</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docscontributinghow-to-update-the-build-image-li><a href=/docs/contributing/how-to-update-the-build-image/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscontributinghow-to-update-the-build-image><span>How to update the build image</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docscontributinghow-to-add-a-maintainer-li><a href=/docs/contributing/how-to-add-a-maintainer/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscontributinghow-to-add-a-maintainer><span>How to add a maintainer</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsroadmap-li><a href=/docs/roadmap/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsroadmap><span>Roadmap</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschangelog-li><a href=/docs/changelog/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschangelog><span>Changelog</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscode-of-conduct-li><a href=/docs/code-of-conduct/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscode-of-conduct><span>Code of Conduct</span></a></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/cortexproject/cortex/edit/master/docs/architecture.md target=_blank><i class="fa fa-edit fa-fw"></i> Edit this page</a>
<a href="https://github.com/cortexproject/cortex/issues/new?title=Cortex%20Architecture" target=_blank><i class="fab fa-github fa-fw"></i> Create documentation issue</a>
<a href=https://github.com/cortexproject/cortex/issues/new target=_blank><i class="fas fa-tasks fa-fw"></i> Create project issue</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#the-role-of-prometheus>The role of Prometheus</a></li><li><a href=#blocks-storage>Blocks storage</a></li><li><a href=#services>Services</a><ul><li><a href=#distributor>Distributor</a></li><li><a href=#ingester>Ingester</a></li><li><a href=#querier>Querier</a></li><li><a href=#compactor>Compactor</a></li><li><a href=#store-gateway>Store gateway</a></li><li><a href=#query-frontend>Query frontend</a></li><li><a href=#query-scheduler>Query Scheduler</a></li><li><a href=#ruler>Ruler</a></li><li><a href=#alertmanager>Alertmanager</a></li><li><a href=#configs-api>Configs API</a></li></ul></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class=td-breadcrumbs><ol class=breadcrumb><li class=breadcrumb-item><a href=/docs/>Documentation</a></li><li class="breadcrumb-item active" aria-current=page><a href=/docs/architecture/ aria-disabled=true class="btn-link disabled">Architecture</a></li></ol></nav><div class=td-content><h1>Cortex Architecture</h1><header class=article-meta></header><p>Cortex consists of multiple horizontally scalable microservices. Each microservice uses the most appropriate technique for horizontal scaling; most are stateless and can handle requests for any users while some (namely the <a href=#ingester>ingesters</a>) are semi-stateful and depend on consistent hashing. This document provides a basic overview of Cortex&rsquo;s architecture.</p><p>The following diagram does not include all the Cortex services, but does represent a typical deployment topology.</p><p align=center><img src=/images/architecture.png alt="Cortex Architecture"></p><h2 id=the-role-of-prometheus>The role of Prometheus</h2><p>Prometheus instances scrape samples from various targets and then push them to Cortex (using Prometheus&rsquo; <a href=https://prometheus.io/docs/prometheus/latest/storage/#remote-storage-integrations>remote write API</a>). That remote write API emits batched <a href=https://google.github.io/snappy/>Snappy</a>-compressed <a href=https://developers.google.com/protocol-buffers/>Protocol Buffer</a> messages inside the body of an HTTP <code>PUT</code> request.</p><p>Cortex requires that each HTTP request bear a header specifying a tenant ID for the request. Request authentication and authorization are handled by an external reverse proxy.</p><p>Incoming samples (writes from Prometheus) are handled by the <a href=#distributor>distributor</a> while incoming reads (PromQL queries) are handled by the <a href=#querier>querier</a> or optionally by the <a href=#query-frontend>query frontend</a>.</p><h2 id=blocks-storage>Blocks storage</h2><p>The blocks storage is based on <a href=https://prometheus.io/docs/prometheus/latest/storage/>Prometheus TSDB</a>: it stores each tenant&rsquo;s time series into their own TSDB which write out their series to a on-disk Block (defaults to 2h block range periods). Each Block is composed by a few files storing the chunks and the block index.</p><p>The TSDB chunk files contain the samples for multiple series. The series inside the Chunks are then indexed by a per-block index, which indexes metric names and labels to time series in the chunk files.</p><p>The blocks storage doesn&rsquo;t require a dedicated storage backend for the index. The only requirement is an object store for the Block files, which can be:</p><ul><li><a href=https://aws.amazon.com/s3>Amazon S3</a></li><li><a href=https://cloud.google.com/storage/>Google Cloud Storage</a></li><li><a href=https://azure.microsoft.com/en-us/services/storage/>Microsoft Azure Storage</a></li><li><a href=https://wiki.openstack.org/wiki/Swift>OpenStack Swift</a> (experimental)</li><li><a href=https://thanos.io/storage.md/#filesystem>Local Filesystem</a> (single node only)</li></ul><p>For more information, please check out the <a href=/docs/blocks-storage/>Blocks storage</a> documentation.</p><h2 id=services>Services</h2><p>Cortex has a service-based architecture, in which the overall system is split up into a variety of components that perform a specific task. These components run separately and in parallel. Cortex can alternatively run in a single process mode, where all components are executed within a single process. The single process mode is particularly handy for local testing and development.</p><p>The Cortex services are:</p><ul><li><a href=#distributor>Distributor</a></li><li><a href=#ingester>Ingester</a></li><li><a href=#querier>Querier</a></li><li><a href=#compactor>Compactor</a></li><li><a href=#store-gateway>Store gateway</a></li><li><a href=#alertmanager>Alertmanager</a> (optional)</li><li><a href=#configs-api>Configs API</a> (optional)</li><li><a href=/docs/guides/overrides-exporter/>Overrides exporter</a> (optional)</li><li><a href=#query-frontend>Query frontend</a> (optional)</li><li><a href=/docs/operations/scaling-query-frontend/#query-scheduler>Query scheduler</a> (optional)</li><li><a href=#ruler>Ruler</a> (optional)</li></ul><h3 id=distributor>Distributor</h3><p>The <strong>distributor</strong> service is responsible for handling incoming samples from Prometheus. It&rsquo;s the first stop in the write path for series samples. Once the distributor receives samples from Prometheus, each sample is validated for correctness and to ensure that it is within the configured tenant limits, falling back to default ones in case limits have not been overridden for the specific tenant. Valid samples are then split into batches and sent to multiple <a href=#ingester>ingesters</a> in parallel.</p><p>The validation done by the distributor includes:</p><ul><li>The metric labels name are formally correct</li><li>The configured max number of labels per metric is respected</li><li>The configured max length of a label name and value is respected</li><li>The timestamp is not older/newer than the configured min/max time range</li></ul><p>Distributors are <strong>stateless</strong> and can be scaled up and down as needed.</p><h4 id=high-availability-tracker>High Availability Tracker</h4><p>The distributor features a <strong>High Availability (HA) Tracker</strong>. When enabled, the distributor deduplicates incoming samples from redundant Prometheus servers. This allows you to have multiple HA replicas of the same Prometheus servers, writing the same series to Cortex and then deduplicate these series in the Cortex distributor.</p><p>The HA Tracker deduplicates incoming samples based on a cluster and replica label. The cluster label uniquely identifies the cluster of redundant Prometheus servers for a given tenant, while the replica label uniquely identifies the replica within the Prometheus cluster. Incoming samples are considered duplicated (and thus dropped) if received by any replica which is not the current primary within a cluster.</p><p>The HA Tracker requires a key-value (KV) store to coordinate which replica is currently elected. The distributor will only accept samples from the current leader. Samples with one or no labels (of the replica and cluster) are accepted by default and never deduplicated.</p><p>The supported KV stores for the HA tracker are:</p><ul><li><a href=https://www.consul.io>Consul</a></li><li><a href=https://etcd.io>Etcd</a></li></ul><p>Note: Memberlist is not supported. Memberlist-based KV store propagates updates using gossip, which is very slow for HA purposes: result is that different distributors may see different Prometheus server as elected HA replica, which is definitely not desirable.</p><p>For more information, please refer to <a href=/docs/guides/ha-pair-handling/>config for sending HA pairs data to Cortex</a> in the documentation.</p><h4 id=hashing>Hashing</h4><p>Distributors use consistent hashing, in conjunction with a configurable replication factor, to determine which ingester instance(s) should receive a given series.</p><p>Cortex supports two hashing strategies:</p><ol><li>Hash the metric name and tenant ID (default)</li><li>Hash the metric name, labels and tenant ID (enabled with <code>-distributor.shard-by-all-labels=true</code>)</li></ol><p>The trade-off associated with the latter is that writes are more balanced across ingesters but each query needs to talk to all ingesters since a metric could be spread across multiple ingesters given different label sets.</p><h4 id=the-hash-ring>The hash ring</h4><p>A hash ring (stored in a key-value store) is used to achieve consistent hashing for the series sharding and replication across the ingesters. All <a href=#ingester>ingesters</a> register themselves into the hash ring with a set of tokens they own; each token is a random unsigned 32-bit number. Each incoming series is <a href=#hashing>hashed</a> in the distributor and then pushed to the ingester owning the tokens range for the series hash number plus N-1 subsequent ingesters in the ring, where N is the replication factor.</p><p>To do the hash lookup, distributors find the smallest appropriate token whose value is larger than the <a href=#hashing>hash of the series</a>. When the replication factor is larger than 1, the next subsequent tokens (clockwise in the ring) that belong to different ingesters will also be included in the result.</p><p>The effect of this hash set up is that each token that an ingester owns is responsible for a range of hashes. If there are three tokens with values 0, 25, and 50, then a hash of 3 would be given to the ingester that owns the token 25; the ingester owning token 25 is responsible for the hash range of 1-25.</p><p>The supported KV stores for the hash ring are:</p><ul><li><a href=https://www.consul.io>Consul</a></li><li><a href=https://etcd.io>Etcd</a></li><li>Gossip <a href=https://github.com/hashicorp/memberlist>memberlist</a></li></ul><h4 id=quorum-consistency>Quorum consistency</h4><p>Since all distributors share access to the same hash ring, write requests can be sent to any distributor and you can setup a stateless load balancer in front of it.</p><p>To ensure consistent query results, Cortex uses <a href=https://www.allthingsdistributed.com/files/amazon-dynamo-sosp2007.pdf>Dynamo-style</a> quorum consistency on reads and writes. This means that the distributor will wait for a positive response of at least one half plus one of the ingesters to send the sample to before successfully responding to the Prometheus write request.</p><h4 id=load-balancing-across-distributors>Load balancing across distributors</h4><p>We recommend randomly load balancing write requests across distributor instances. For example, if you&rsquo;re running Cortex in a Kubernetes cluster, you could run the distributors as a Kubernetes <a href=https://kubernetes.io/docs/concepts/services-networking/service/>Service</a>.</p><h3 id=ingester>Ingester</h3><p>The <strong>ingester</strong> service is responsible for writing incoming series to a <a href=#blocks-storage>long-term storage backend</a> on the write path and returning in-memory series samples for queries on the read path.</p><p>Incoming series are not immediately written to the storage but kept in memory and periodically flushed to the storage (by default, 2 hours). For this reason, the <a href=#querier>queriers</a> may need to fetch samples both from ingesters and long-term storage while executing a query on the read path.</p><p>Ingesters contain a <strong>lifecycler</strong> which manages the lifecycle of an ingester and stores the <strong>ingester state</strong> in the <a href=#the-hash-ring>hash ring</a>. Each ingester could be in one of the following states:</p><ul><li><strong><code>PENDING</code></strong><br>The ingester has just started. While in this state, the ingester doesn&rsquo;t receive neither write and read requests.</li><li><strong><code>JOINING</code></strong><br>The ingester is starting up and joining the ring. While in this state the ingester doesn&rsquo;t receive neither write and read requests. The ingester will join the ring using tokens loaded from disk (if <code>-ingester.tokens-file-path</code> is configured) or generate a set of new random ones. Finally, the ingester optionally observes the ring for tokens conflicts and then, once any conflict is resolved, will move to <code>ACTIVE</code> state.</li><li><strong><code>ACTIVE</code></strong><br>The ingester is up and running. While in this state the ingester can receive both write and read requests.</li><li><strong><code>LEAVING</code></strong><br>The ingester is shutting down and leaving the ring. While in this state the ingester doesn&rsquo;t receive write requests, while it could receive read requests.</li><li><strong><code>UNHEALTHY</code></strong><br>The ingester has failed to heartbeat to the ring&rsquo;s KV Store. While in this state, distributors skip the ingester while building the replication set for incoming series and the ingester does not receive write or read requests.</li></ul><p>Ingesters are <strong>semi-stateful</strong>.</p><h4 id=ingesters-failure-and-data-loss>Ingesters failure and data loss</h4><p>If an ingester process crashes or exits abruptly, all the in-memory series that have not yet been flushed to the long-term storage will be lost. There are two main ways to mitigate this failure mode:</p><ol><li>Replication</li><li>Write-ahead log (WAL)</li></ol><p>The <strong>replication</strong> is used to hold multiple (typically 3) replicas of each time series in the ingesters. If the Cortex cluster loses an ingester, the in-memory series held by the lost ingester are also replicated to at least another ingester. In the event of a single ingester failure, no time series samples will be lost. However, in the event of multiple ingester failures, time series may be potentially lost if the failures affect all the ingesters holding the replicas of a specific time series.</p><p>The <strong>write-ahead log</strong> (WAL) is used to write to a persistent disk all incoming series samples until they&rsquo;re flushed to the long-term storage. In the event of an ingester failure, a subsequent process restart will replay the WAL and recover the in-memory series samples.</p><p>Contrary to the sole replication and given the persistent disk data is not lost, in the event of multiple ingesters failure each ingester will recover the in-memory series samples from WAL upon subsequent restart. The replication is still recommended in order to ensure no temporary failures on the read path in the event of a single ingester failure.</p><h4 id=ingesters-write-de-amplification>Ingesters write de-amplification</h4><p>Ingesters store recently received samples in-memory in order to perform write de-amplification. If the ingesters would immediately write received samples to the long-term storage, the system would be very difficult to scale due to the very high pressure on the storage. For this reason, the ingesters batch and compress samples in-memory and periodically flush them out to the storage.</p><p>Write de-amplification is the main source of Cortex&rsquo;s low total cost of ownership (TCO).</p><h3 id=querier>Querier</h3><p>The <strong>querier</strong> service handles queries using the <a href=https://prometheus.io/docs/prometheus/latest/querying/basics/>PromQL</a> query language.</p><p>Queriers fetch series samples both from the ingesters and long-term storage. The ingesters hold the in-memory series that have not yet been flushed to the long-term storage. Because of the replication factor, it is possible that the querier may receive duplicated samples. To address this, the querier internally <strong>deduplicates</strong> samples with the exact same timestamp for a given time series.</p><p>Queriers are <strong>stateless</strong> and can be scaled up and down as needed.</p><h3 id=compactor>Compactor</h3><p>The <strong>compactor</strong> is a service which is responsible to:</p><ul><li>Compact multiple blocks of a given tenant into a single optimized larger block. This helps to reduce storage costs (deduplication, index size reduction), and increase query speed (querying fewer blocks is faster).</li><li>Keep the per-tenant bucket index updated. The <a href=/docs/blocks-storage/bucket-index/>bucket index</a> is used by <a href=/docs/blocks-storage/querier/>queriers</a>, <a href=#store-gateway>store-gateways</a> and rulers to discover new blocks in the storage.</li></ul><p>For more information, see the <a href=/docs/blocks-storage/compactor/>compactor documentation</a>.</p><p>The compactor is <strong>stateless</strong>.</p><h3 id=store-gateway>Store gateway</h3><p>The <strong>store gateway</strong> is the Cortex service responsible to query series from blocks, it needs to have an almost up-to-date view over the storage bucket. In order to discover blocks belonging to their shard. The store-gateway can keep the bucket view updated in to two different ways:</p><ol><li>Periodically scanning the bucket (default)</li><li>Periodically downloading the <a href=/docs/blocks-storage/bucket-index/>bucket index</a></li></ol><p>For more information, see the <a href=/docs/blocks-storage/store-gateway/>store gateway documentation</a>.</p><p>The store gateway is <strong>semi-stateful</strong>.</p><h3 id=query-frontend>Query frontend</h3><p>The <strong>query frontend</strong> is an <strong>optional service</strong> providing the querier&rsquo;s API endpoints and can be used to accelerate the read path. When the query frontend is in place, incoming query requests should be directed to the query frontend instead of the queriers. The querier service will be still required within the cluster, in order to execute the actual queries.</p><p>The query frontend internally performs some query adjustments and holds queries in an internal queue. In this setup, queriers act as workers which pull jobs from the queue, execute them, and return them to the query-frontend for aggregation. Queriers need to be configured with the query frontend address (via the <code>-querier.frontend-address</code> CLI flag) in order to allow them to connect to the query frontends.</p><p>Query frontends are <strong>stateless</strong>. However, due to how the internal queue works, it&rsquo;s recommended to run a few query frontend replicas to reap the benefit of fair scheduling. Two replicas should suffice in most cases.</p><p>Flow of the query in the system when using query-frontend:</p><ol><li>Query is received by query frontend, which can optionally split it or serve from the cache.</li><li>Query frontend stores the query into in-memory queue, where it waits for some querier to pick it up.</li><li>Querier picks up the query, and executes it.</li><li>Querier sends result back to query-frontend, which then forwards it to the client.</li></ol><p>Query frontend can also be used with any Prometheus-API compatible service. In this mode Cortex can be used as an query accelerator with it&rsquo;s caching and splitting features on other prometheus query engines like Thanos Querier or your own Prometheus server. Query frontend needs to be configured with downstream url address(via the <code>-frontend.downstream-url</code> CLI flag), which is the endpoint of the prometheus server intended to be connected with Cortex.</p><h4 id=queueing>Queueing</h4><p>The query frontend queuing mechanism is used to:</p><ul><li>Ensure that large queries, that could cause an out-of-memory (OOM) error in the querier, will be retried on failure. This allows administrators to under-provision memory for queries, or optimistically run more small queries in parallel, which helps to reduce the total cost of ownership (TCO).</li><li>Prevent multiple large requests from being convoyed on a single querier by distributing them across all queriers using a first-in/first-out queue (FIFO).</li><li>Prevent a single tenant from denial-of-service-ing (DOSing) other tenants by fairly scheduling queries between tenants.</li></ul><h4 id=splitting>Splitting</h4><p>The query frontend splits multi-day queries into multiple single-day queries, executing these queries in parallel on downstream queriers and stitching the results back together again. This prevents large (multi-day) queries from causing out of memory issues in a single querier and helps to execute them faster.</p><h4 id=caching>Caching</h4><p>The query frontend supports caching query results and reuses them on subsequent queries. If the cached results are incomplete, the query frontend calculates the required subqueries and executes them in parallel on downstream queriers. The query frontend can optionally align queries with their step parameter to improve the cacheability of the query results. The result cache is compatible with any cortex caching backend (currently memcached, redis, and an in-memory cache).</p><h3 id=query-scheduler>Query Scheduler</h3><p>Query Scheduler is an <strong>optional</strong> service that moves the internal queue from query frontend into separate component.
This enables independent scaling of query frontends and number of queues (query scheduler).</p><p>In order to use query scheduler, both query frontend and queriers must be configured with query scheduler address
(using <code>-frontend.scheduler-address</code> and <code>-querier.scheduler-address</code> options respectively).</p><p>Flow of the query in the system changes when using query scheduler:</p><ol><li>Query is received by query frontend, which can optionally split it or serve from the cache.</li><li>Query frontend forwards the query to random query scheduler process.</li><li>Query scheduler stores the query into in-memory queue, where it waits for some querier to pick it up.</li><li>Querier picks up the query, and executes it.</li><li>Querier sends result back to query-frontend, which then forwards it to the client.</li></ol><p>Query schedulers are <strong>stateless</strong>. It is recommended to run two replicas to make sure queries can still be serviced while one replica is restarting.</p><h3 id=ruler>Ruler</h3><p>The <strong>ruler</strong> is an <strong>optional service</strong> executing PromQL queries for recording rules and alerts. The ruler requires a database storing the recording rules and alerts for each tenant.</p><p>Ruler is <strong>semi-stateful</strong> and can be scaled horizontally.
Running rules internally have state, as well as the ring the rulers initiate.
However, if the rulers all fail and restart,
Prometheus alert rules have a feature where an alert is restored and returned to a firing state
if it would have been active in its for period.
However, there would be gaps in the series generated by the recording rules.</p><h3 id=alertmanager>Alertmanager</h3><p>The <strong>alertmanager</strong> is an <strong>optional service</strong> responsible for accepting alert notifications from the <a href=#ruler>ruler</a>, deduplicating and grouping them, and routing them to the correct notification channel, such as email, PagerDuty or OpsGenie.</p><p>The Cortex alertmanager is built on top of the <a href=https://prometheus.io/docs/alerting/alertmanager/>Prometheus Alertmanager</a>, adding multi-tenancy support. Like the <a href=#ruler>ruler</a>, the alertmanager requires a database storing the per-tenant configuration.</p><p>Alertmanager is <strong>semi-stateful</strong>.
The Alertmanager persists information about silences and active alerts to its disk.
If all of the alertmanager nodes failed simultaneously there would be a loss of data.</p><h3 id=configs-api>Configs API</h3><p>The <strong>configs API</strong> is an <strong>optional service</strong> managing the configuration of Rulers and Alertmanagers.
It provides APIs to get/set/update the ruler and alertmanager configurations and store them into backend.
Current supported backend are PostgreSQL and in-memory.</p><p>Configs API is <strong>stateless</strong>.</p></div></main></div></div><footer><div class="row td-box td-box--dark td-box--gradient td-box--height-auto text-white p-5"><div class="col-12 col-sm-4 pb-5 pb-sm-0"><img src=/images/cortex-stacked-white.png width=75px class="img-fluid float-left"></div><div class="col-12 col-sm-4 pb-5 pb-sm-0"><h6 class=font-weight-bold>Community</h6><ul class=list-unstyled><li><a href=https://slack.cncf.io class="text-reset text-white"><i class="fab fa-fw fa-slack"></i> Slack</a></li><li><a href=https://github.com/cortexproject/cortex class="text-reset text-white"><i class="fab fa-fw fa-github"></i> GitHub</a></li><li><a href=https://twitter.com/cortexmetrics class="text-reset text-white"><i class="fab fa-fw fa-twitter"></i> Twitter</a></li></ul></div><div class="col-12 col-sm-4"><h6 class=font-weight-bold>About</h6><p>Cortex is an OSS licensed project as Apache License 2.0</p></div></div><div class="row td-box td-box--dark td-box--gradient td-box--height-auto text-white p-5 text-center"><small class="col-12 text-center">© 2024 The Cortex Authors All Rights Reserved.<br>The Linux Foundation has registered trademarks and uses trademarks.
For a list of trademarks of The Linux Foundation, please see <a class="text-light alert-link" href=https://www.linuxfoundation.org/trademark-usage>Trademark Usage page</a>.</small></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA==" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script>
<script src=/js/main.min.91798a335c881f1b6b805085ba4aa22d1dbd2b0b18d105d05189fa104ddae350.js integrity="sha256-kXmKM1yIHxtrgFCFukqiLR29KwsY0QXQUYn6EE3a41A=" crossorigin=anonymous></script></body></html>