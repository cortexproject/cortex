<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.101.0"><meta name=robots content="index, follow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Shuffle sharding and zone awareness | Cortex</title><meta name=description content="
Author: @pracucci, @tomwilkie, @pstibrany
Reviewers:
Date: August 2020
Status: Accepted, implemented in PR #3090

Shuffle sharding and zone awareness …"><meta property="og:title" content="Shuffle sharding and zone awareness"><meta property="og:description" content="Author: @pracucci, @tomwilkie, @pstibrany Reviewers: Date: August 2020 Status: Accepted, implemented in PR #3090 Shuffle sharding and zone awareness Background Cortex shards the received series across all available ingesters. In a multi-tenant cluster, each tenant series are sharded across all ingesters. This allows to horizontally scale the series across the pool of ingesters but also suffers some issues:
Given every tenant writes series to all ingesters, there’s no isolation between tenants - a single misbehaving tenant can affect the whole cluster."><meta property="og:type" content="article"><meta property="og:url" content="/docs/proposals/shuffle-sharding-and-zone-awareness/"><meta property="og:image" content="/images/logo-twitter-card.jpg"><meta property="article:section" content="docs"><meta property="og:site_name" content="Cortex"><meta itemprop=name content="Shuffle sharding and zone awareness"><meta itemprop=description content="Author: @pracucci, @tomwilkie, @pstibrany Reviewers: Date: August 2020 Status: Accepted, implemented in PR #3090 Shuffle sharding and zone awareness Background Cortex shards the received series across all available ingesters. In a multi-tenant cluster, each tenant series are sharded across all ingesters. This allows to horizontally scale the series across the pool of ingesters but also suffers some issues:
Given every tenant writes series to all ingesters, there’s no isolation between tenants - a single misbehaving tenant can affect the whole cluster."><meta itemprop=wordCount content="1054"><meta itemprop=image content="/images/logo-twitter-card.jpg"><meta itemprop=keywords content><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/images/logo-twitter-card.jpg"><meta name=twitter:title content="Shuffle sharding and zone awareness"><meta name=twitter:description content="Author: @pracucci, @tomwilkie, @pstibrany Reviewers: Date: August 2020 Status: Accepted, implemented in PR #3090 Shuffle sharding and zone awareness Background Cortex shards the received series across all available ingesters. In a multi-tenant cluster, each tenant series are sharded across all ingesters. This allows to horizontally scale the series across the pool of ingesters but also suffers some issues:
Given every tenant writes series to all ingesters, there’s no isolation between tenants - a single misbehaving tenant can affect the whole cluster."><link rel=preload href=/scss/main.min.b2327889d9640582f368772c608732b32a6fa5b2b0c58b3d3c1d139029933f80.css as=style><link href=/scss/main.min.b2327889d9640582f368772c608732b32a6fa5b2b0c58b3d3c1d139029933f80.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SRR0DSREGX"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-SRR0DSREGX",{anonymize_ip:!1})}</script></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar navbar-nocover"><a id=cortex-logo class=navbar-brand href=/><span class=navbar-logo><svg xmlns="http://www.w3.org/2000/svg" role="img" viewBox="-17.92 -14.92 1191.84 462.84"><defs><style>.cls-1{fill:#fff}</style></defs><path d="M214.531 8.017C99.353 8.017 5.65 101.72 5.65 216.899S99.353 425.78 214.531 425.78s208.882-93.704 208.882-208.882S329.71 8.017 214.531 8.017zm0 408.558c-110.102.0-199.676-89.574-199.676-199.676S104.429 17.222 214.53 17.222 414.208 106.797 414.208 216.9 324.633 416.575 214.53 416.575z" class="cls-1"/><circle cx="327.452" cy="221.633" r="34.571" class="cls-1"/><circle cx="213.713" cy="353.584" r="34.571" class="cls-1"/><path d="M299.992 167.913l-59-56.05a34.578 34.578.0 10-4.343 4.34l57.828 54.937a60.158 60.158.0 00-27.168 49.123h-12.97l-23.456-67.02-26.055 64.718H175.73l-24.724 57.22-21.808-54.524-.063.025v-.586h-22.048a34.582 34.582.0 10-.275 6.138h18.005l25.97 64.925 28.977-67.06h29.207l21.51-53.424 19.503 55.725H267.5a60.173 60.173.0 0025.202 44.11l-56.52 56.52 4.34 4.338 57.492-57.492a60.155 60.155.0 101.977-105.963zm81.481 53.515a54.02 54.02.0 11-54.022-54.02 54.083 54.083.0 0154.022 54.02zm175.707 42.568q-8.797 8.178-24.405 8.177a34.858 34.858.0 01-17.095-3.965 33.188 33.188.0 01-11.643-10.529 46.374 46.374.0 01-6.566-14.99 71.134 71.134.0 01-2.105-17.341 86.99 86.99.0 011.982-18.706 46.804 46.804.0 016.565-15.98 34.028 34.028.0 0112.263-11.149q7.675-4.21 19.077-4.212 13.38.0 21.306 6.69 7.927 6.689 10.405 18.829h21.803a50.76 50.76.0 00-5.946-19.696 44.06 44.06.0 00-12.015-13.75 49.842 49.842.0 00-16.848-8.051 77.44 77.44.0 00-20.44-2.601q-15.114.0-26.509 5.326a52.935 52.935.0 00-18.952 14.617 62.165 62.165.0 00-11.273 21.8 94.013 94.013.0 00-3.717 26.883 86.195 86.195.0 003.84 26.386 57.783 57.783.0 0011.397 20.686 50.138 50.138.0 0018.829 13.38 66.766 66.766.0 0025.891 4.705q24.527.0 38.772-12.882 14.245-12.878 17.715-36.668h-21.556q-1.986 14.867-10.776 23.041zm157.44-87.828a56.338 56.338.0 00-19.447-14.244q-11.52-5.203-26.882-5.203-15.115.0-26.756 5.203a56.009 56.009.0 00-19.573 14.244 59.75 59.75.0 00-11.892 21.307 85.299 85.299.0 00-3.965 26.386 84.117 84.117.0 003.965 26.262 59.853 59.853.0 0011.892 21.183 54.61 54.61.0 0019.573 14.12q11.643 5.077 26.756 5.08 15.36.0 26.882-5.08a54.908 54.908.0 0019.447-14.12 59.95 59.95.0 0011.892-21.183 84.181 84.181.0 003.965-26.262 85.364 85.364.0 00-3.965-26.386 59.846 59.846.0 00-11.892-21.307zm-9.538 68.38a43.305 43.305.0 01-8.548 15.113 37.061 37.061.0 01-12.759 9.29 38.825 38.825.0 01-30.968.0 37.003 37.003.0 01-12.76-9.29 43.209 43.209.0 01-8.547-15.114 70.669 70.669.0 010-41.373 44.634 44.634.0 018.547-15.237 36.428 36.428.0 0112.76-9.415 38.826 38.826.0 0130.968.0 36.484 36.484.0 0112.76 9.415 44.735 44.735.0 018.547 15.237 70.624 70.624.0 010 41.373zm81.141-80.89q-11.147 7.434-18.83 23.041h-.493v-27.005h-19.82V287.78h21.057v-56.984a87.528 87.528.0 012.478-21.924 41.993 41.993.0 017.93-16.228 33.951 33.951.0 0114.368-10.158q8.919-3.468 21.555-3.468V156.72q-17.097-.493-28.245 6.937zm80.761-42.366h-21.06v38.402h-21.8v18.581h21.8v81.51a48.668 48.668.0 001.734 14.37 17.432 17.432.0 005.326 8.423 20.57 20.57.0 009.415 4.088 75.59 75.59.0 0013.999 1.115h16.104v-18.582h-9.664a70.335 70.335.0 01-8.05-.37 10.361 10.361.0 01-4.833-1.611 6.108 6.108.0 01-2.354-3.469 23.006 23.006.0 01-.617-5.946v-79.528h25.518v-18.581h-25.518zm148.522 60.452a56.135 56.135.0 00-18.085-17.962q-11.276-7.063-28.367-7.06a58.263 58.263.0 00-24.155 4.953A56.796 56.796.0 00925.82 175.55a63.949 63.949.0 00-12.51 21.058 77.064 77.064.0 00-4.461 26.758 102.521 102.521.0 004.338 27.004 58.87 58.87.0 0011.519 21.307 52.43 52.43.0 0018.953 13.873q11.272 4.954 26.632 4.955 21.8.0 36.173-10.901 14.364-10.898 18.58-32.455h-20.81q-2.73 12.635-11.272 18.829-8.549 6.198-21.927 6.195a43.577 43.577.0 01-18.085-3.468 35.417 35.417.0 01-12.636-9.291 36.127 36.127.0 01-7.184-13.38 50.746 50.746.0 01-1.981-15.98h95.879a102.07 102.07.0 00-2.107-24.526 71.064 71.064.0 00-9.415-23.784zm-84.357 29.73a43.81 43.81.0 013.219-13.999 37.354 37.354.0 017.433-11.52 34.013 34.013.0 0111.272-7.803 36.694 36.694.0 0114.74-2.85 36.062 36.062.0 0114.494 2.85 36.492 36.492.0 0111.398 7.68 36.107 36.107.0 017.68 11.52 43.253 43.253.0 013.345 14.122zm170.95 7.184 44.1-58.964h-25.271l-31.961 44.843-30.721-44.843h-27.006l44.595 60.698-48.063 67.389h25.518l35.677-53.019 35.676 53.019h27.006l-49.55-69.123z" class="cls-1"/></svg></span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/docs/><span class=active>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a href=https://twitter.com/cortexmetrics class="nav-link active"><span class=active><i class="fab fa-fw fa-twitter"></i> Twitter</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a href=https://github.com/cortexproject class="nav-link active"><span class=active><i class="fab fa-fw fa-github"></i> GitHub</span></a></li></ul></div><div class="navbar-nav d-none d-md-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.ca4ddf48b94dd33022168b88c5f7b024.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><div id=content-mobile><form class="td-sidebar__search d-flex align-items-center"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.ca4ddf48b94dd33022168b88c5f7b024.json data-offline-search-base-href=/ data-offline-search-max-results=10>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-section-nav aria-expanded=false aria-label="Toggle section navigation"></button></form></div><div id=content-desktop></div><nav class="collapse td-sidebar-nav" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docs-li><a href=/docs/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-docs><span>Documentation</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsgetting-started-li><a href=/docs/getting-started/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsgetting-started><span>Getting Started</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsarchitecture-li><a href=/docs/architecture/ title="Cortex Architecture" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsarchitecture><span>Architecture</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docsblocks-storage-li><a href=/docs/blocks-storage/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsblocks-storage><span>Blocks Storage</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsblocks-storagequerier-li><a href=/docs/blocks-storage/querier/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storagequerier><span>Querier</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsblocks-storagestore-gateway-li><a href=/docs/blocks-storage/store-gateway/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storagestore-gateway><span>Store-gateway</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsblocks-storagecompactor-li><a href=/docs/blocks-storage/compactor/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storagecompactor><span>Compactor</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsblocks-storageproduction-tips-li><a href=/docs/blocks-storage/production-tips/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storageproduction-tips><span>Production tips</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsblocks-storagebinary-index-header-li><a href=/docs/blocks-storage/binary-index-header/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storagebinary-index-header><span>Binary index-header</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsblocks-storagebucket-index-li><a href=/docs/blocks-storage/bucket-index/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storagebucket-index><span>Bucket Index</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsblocks-storagemigrate-cortex-cluster-from-chunks-to-blocks-li><a href=/docs/blocks-storage/migrate-cortex-cluster-from-chunks-to-blocks/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storagemigrate-cortex-cluster-from-chunks-to-blocks><span>Migrate Cortex cluster from chunks to blocks</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsblocks-storageconvert-long-term-storage-from-chunks-to-blocks-li><a href=/docs/blocks-storage/convert-long-term-storage-from-chunks-to-blocks/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storageconvert-long-term-storage-from-chunks-to-blocks><span>Convert long-term storage from chunks to blocks</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsblocks-storagemigrate-storage-from-thanos-and-prometheus-li><a href=/docs/blocks-storage/migrate-storage-from-thanos-and-prometheus/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storagemigrate-storage-from-thanos-and-prometheus><span>Migrate the storage from Thanos and Prometheus</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsblocks-storagelearn-more-li><a href=/docs/blocks-storage/learn-more/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storagelearn-more><span>Learn more</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docsconfiguration-li><a href=/docs/configuration/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsconfiguration><span>Configuration</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsconfigurationconfiguration-file-li><a href=/docs/configuration/configuration-file/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsconfigurationconfiguration-file><span>Configuration file</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsconfigurationarguments-li><a href=/docs/configuration/arguments/ title="Cortex Arguments" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsconfigurationarguments><span>Cortex Arguments Explained</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsconfigurationprometheus-frontend-li><a href=/docs/configuration/prometheus-frontend/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsconfigurationprometheus-frontend><span>Prometheus Frontend</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsconfigurationv1guarantees-li><a href=/docs/configuration/v1guarantees/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsconfigurationv1guarantees><span>v1.x Guarantees</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docsguides-li><a href=/docs/guides/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsguides><span>Guides</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidesrunning-cortex-on-kubernetes-li><a href=/docs/guides/running-cortex-on-kubernetes/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidesrunning-cortex-on-kubernetes><span>Running Cortex on Kubernetes</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidesgetting-started-with-gossiped-ring-li><a href=/docs/guides/getting-started-with-gossiped-ring/ title="Getting started with gossiped ring" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidesgetting-started-with-gossiped-ring><span>Getting started with a gossip ring cluster</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidesalertmanager-configuration-li><a href=/docs/guides/alertmanager-configuration/ title="Configuring Notification using Cortex Alertmanager" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidesalertmanager-configuration><span>Alertmanager configuration</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidesauth-li><a href=/docs/guides/auth/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidesauth><span>Authentication and Authorisation</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidescapacity-planning-li><a href=/docs/guides/capacity-planning/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidescapacity-planning><span>Capacity Planning</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidesruler-sharding-li><a href=/docs/guides/ruler-sharding/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidesruler-sharding><span>Config for horizontally scaling the Ruler</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidesha-pair-handling-li><a href=/docs/guides/ha-pair-handling/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidesha-pair-handling><span>Config for sending HA Pairs data to Cortex</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidesencryption-at-rest-li><a href=/docs/guides/encryption-at-rest/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidesencryption-at-rest><span>Encryption at Rest</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidesingesters-rolling-updates-li><a href=/docs/guides/ingesters-rolling-updates/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidesingesters-rolling-updates><span>Ingesters rolling updates</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidesingesters-scaling-up-and-down-li><a href=/docs/guides/ingesters-scaling-up-and-down/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidesingesters-scaling-up-and-down><span>Ingesters scaling up and down</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidesoverrides-exporter-li><a href=/docs/guides/overrides-exporter/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidesoverrides-exporter><span>Overrides Exporter</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidestls-li><a href=/docs/guides/tls/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidestls><span>Securing communication between Cortex components with TLS</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidessecurity-li><a href=/docs/guides/security/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidessecurity><span>Security</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidesshuffle-sharding-li><a href=/docs/guides/shuffle-sharding/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidesshuffle-sharding><span>Shuffle Sharding</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidestracing-li><a href=/docs/guides/tracing/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidestracing><span>Tracing</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguideszone-aware-replication-li><a href=/docs/guides/zone-aware-replication/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguideszone-aware-replication><span>Zone Aware Replication</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguideslimitations-li><a href=/docs/guides/limitations/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguideslimitations><span>Limitations</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidesglossary-li><a href=/docs/guides/glossary/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidesglossary><span>Glossary</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsapi-li><a href=/docs/api/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsapi><span>HTTP API</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docsoperations-li><a href=/docs/operations/ title="Operating Cortex" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsoperations><span>Operations</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsoperationsquery-auditor-li><a href=/docs/operations/query-auditor/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsoperationsquery-auditor><span>Query Auditor (tool)</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsoperationsquery-tee-li><a href=/docs/operations/query-tee/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsoperationsquery-tee><span>Query Tee (service)</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsoperationsrequests-mirroring-to-secondary-cluster-li><a href=/docs/operations/requests-mirroring-to-secondary-cluster/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsoperationsrequests-mirroring-to-secondary-cluster><span>Requests mirroring to secondary cluster</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsoperationsscaling-query-frontend-li><a href=/docs/operations/scaling-query-frontend/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsoperationsscaling-query-frontend><span>Scaling the Query Frontend</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docscase-studies-li><a href=/docs/case-studies/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docscase-studies><span>Case Studies</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docscase-studiesgojek-li><a href=/docs/case-studies/gojek/ title="How Gojek Is Leveraging Cortex to Keep Up with Its Ever-Growing Scale" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscase-studiesgojek><span>Gojek</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docscase-studiesrewe-digital-li><a href=/docs/case-studies/rewe-digital/ title="How Cortex helped REWE digital ensure stability while scaling services during the Covid-19 pandemic" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscase-studiesrewe-digital><span>REWE digital</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docscase-studiesbuoyant-cloud-li><a href=/docs/case-studies/buoyant-cloud/ title="Buoyant Cloud and Cortex: Standing on the shoulders of Linkerd and Prometheus" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscase-studiesbuoyant-cloud><span>Buoyant Cloud</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docsproposals-li><a href=/docs/proposals/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsproposals><span>Proposals</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsproposalsauth-gateway-li><a href=/docs/proposals/auth-gateway/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalsauth-gateway><span>Authentication Gateway</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsproposalsblocks-storage-bucket-index-li><a href=/docs/proposals/blocks-storage-bucket-index/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalsblocks-storage-bucket-index><span>Blocks storage bucket index</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsproposalsblocks-storage-sharding-li><a href=/docs/proposals/blocks-storage-sharding/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalsblocks-storage-sharding><span>Blocks storage sharding</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsproposalscross-tenant-query-federation-li><a href=/docs/proposals/cross-tenant-query-federation/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalscross-tenant-query-federation><span>Cross-Tenant Query Federation</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsproposalstenant-deletion-li><a href=/docs/proposals/tenant-deletion/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalstenant-deletion><span>Deletion of Tenant Data from Blocks Storage</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsproposalsdocumentation-versioning-li><a href=/docs/proposals/documentation-versioning/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalsdocumentation-versioning><span>Documentation Versioning</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsproposalsgeneralize-modules-li><a href=/docs/proposals/generalize-modules/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalsgeneralize-modules><span>Generalize Modules Service to make it extensible</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsproposalshttp-api-design-li><a href=/docs/proposals/http-api-design/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalshttp-api-design><span>HTTP API Design</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsproposalsingesters-migration-li><a href=/docs/proposals/ingesters-migration/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalsingesters-migration><span>Migrating ingesters from chunks to blocks and back.</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsproposalsparallel-compaction-li><a href=/docs/proposals/parallel-compaction/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalsparallel-compaction><span>Parallel Compaction by Time Interval</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsproposalstenant-retention-li><a href=/docs/proposals/tenant-retention/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalstenant-retention><span>Retention of Tenant Data from Blocks Storage</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsproposalsring-multikey-li><a href=/docs/proposals/ring-multikey/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalsring-multikey><span>Ring Multikey</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsproposalsruler-ha-li><a href=/docs/proposals/ruler-ha/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalsruler-ha><span>Ruler HA</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsproposalsruler-high-availability-li><a href=/docs/proposals/ruler-high-availability/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalsruler-high-availability><span>Ruler High Availability</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsproposalsruler-tenant-federation-li><a href=/docs/proposals/ruler-tenant-federation/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalsruler-tenant-federation><span>Ruler Tenant Federation</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsproposalsscalable-alertmanager-li><a href=/docs/proposals/scalable-alertmanager/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalsscalable-alertmanager><span>Scalable Alertmanager</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsproposalsscalable-query-frontend-li><a href=/docs/proposals/scalable-query-frontend/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalsscalable-query-frontend><span>Scalable Query Frontend</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-docsproposalsshuffle-sharding-and-zone-awareness-li><a href=/docs/proposals/shuffle-sharding-and-zone-awareness/ class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-docsproposalsshuffle-sharding-and-zone-awareness><span class=td-sidebar-nav-active-item>Shuffle sharding and zone awareness</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsproposalsshuffle-sharding-on-the-read-path-li><a href=/docs/proposals/shuffle-sharding-on-the-read-path/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalsshuffle-sharding-on-the-read-path><span>Shuffle sharding on the read path</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsproposalssupport-metadata-api-li><a href=/docs/proposals/support-metadata-api/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalssupport-metadata-api><span>Support metadata API</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsproposalsblock-storage-time-series-deletion-li><a href=/docs/proposals/block-storage-time-series-deletion/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalsblock-storage-time-series-deletion><span>Time Series Deletion from Blocks Storage</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsproposalstimeseries-partitioning-in-compactor-li><a href=/docs/proposals/timeseries-partitioning-in-compactor/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalstimeseries-partitioning-in-compactor><span>Timeseries Partitioning in Compactor</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docscontributing-li><a href=/docs/contributing/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docscontributing><span>Contributing</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docscontributinggovernance-li><a href=/docs/contributing/governance/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscontributinggovernance><span>Governance</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docscontributingdesign-patterns-and-code-conventions-li><a href=/docs/contributing/design-patterns-and-code-conventions/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscontributingdesign-patterns-and-code-conventions><span>Design patterns and Code conventions</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docscontributinghow-to-run-the-website-locally-li><a href=/docs/contributing/how-to-run-the-website-locally/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscontributinghow-to-run-the-website-locally><span>How to run the website locally</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docscontributinghow-to-upgrade-golang-version-li><a href=/docs/contributing/how-to-upgrade-golang-version/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscontributinghow-to-upgrade-golang-version><span>How to upgrade Golang version</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docscontributinghow-integration-tests-work-li><a href=/docs/contributing/how-integration-tests-work/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscontributinghow-integration-tests-work><span>How integration tests work</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docscontributinghow-to-update-the-build-image-li><a href=/docs/contributing/how-to-update-the-build-image/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscontributinghow-to-update-the-build-image><span>How to update the build image</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docscontributinghow-to-add-a-maintainer-li><a href=/docs/contributing/how-to-add-a-maintainer/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscontributinghow-to-add-a-maintainer><span>How to add a maintainer</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsroadmap-li><a href=/docs/roadmap/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsroadmap><span>Roadmap</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschangelog-li><a href=/docs/changelog/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschangelog><span>Changelog</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscode-of-conduct-li><a href=/docs/code-of-conduct/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscode-of-conduct><span>Code of Conduct</span></a></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/cortexproject/cortex/edit/master/docs/proposals/shuffle-sharding-and-zone-awareness.md target=_blank><i class="fa fa-edit fa-fw"></i> Edit this page</a>
<a href="https://github.com/cortexproject/cortex/issues/new?title=Shuffle%20sharding%20and%20zone%20awareness" target=_blank><i class="fab fa-github fa-fw"></i> Create documentation issue</a>
<a href=https://github.com/cortexproject/cortex/issues/new target=_blank><i class="fas fa-tasks fa-fw"></i> Create project issue</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#shuffle-sharding-and-zone-awareness>Shuffle sharding and zone awareness</a><ul><li><a href=#background>Background</a></li><li><a href=#goal>Goal</a></li><li><a href=#proposal>Proposal</a></li><li><a href=#guaranteed-properties>Guaranteed properties</a></li><li><a href=#proof-of-concept>Proof of concept</a></li></ul></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class=td-breadcrumbs><ol class=breadcrumb><li class=breadcrumb-item><a href=/docs/>Documentation</a></li><li class=breadcrumb-item><a href=/docs/proposals/>Proposals</a></li><li class="breadcrumb-item active" aria-current=page><a href=/docs/proposals/shuffle-sharding-and-zone-awareness/ aria-disabled=true class="btn-link disabled">Shuffle sharding and zone awareness</a></li></ol></nav><div class=td-content><h1>Shuffle sharding and zone awareness</h1><header class=article-meta></header><ul><li>Author: @pracucci, @tomwilkie, @pstibrany</li><li>Reviewers:</li><li>Date: August 2020</li><li>Status: Accepted, implemented in <a href=https://github.com/cortexproject/cortex/pull/3090>PR #3090</a></li></ul><h2 id=shuffle-sharding-and-zone-awareness>Shuffle sharding and zone awareness</h2><h3 id=background>Background</h3><p>Cortex shards the received series across all available ingesters. In a multi-tenant cluster, each tenant series are sharded across all ingesters. This allows to horizontally scale the series across the pool of ingesters but also suffers some issues:</p><ol><li>Given every tenant writes series to all ingesters, there’s no isolation between tenants - a single misbehaving tenant can affect the whole cluster.</li><li>Each ingester needs an open TSDB per tenant per ingester - which has significant memory overhead. The larger the number of tenants, the higher the TSDB memory overhead, regardless of the number of series stored in each TSDB.</li><li>Similarly, the number of uploaded blocks to the storage every 2 hours is a function of the number of TSDBs open for each ingester. A cluster with a large number of small tenants will upload a very large number of blocks to the storage, each block being very small, increasing the number of API calls against the storage bucket.</li></ol><p>Cortex currently supports sharding a tenant to a subset of the ingesters on the write path <a href=https://github.com/cortexproject/cortex/pull/1947>PR</a>, using a feature called “<strong>subring</strong>”. However, the current subring implementation suffers two issues:</p><ol><li><strong>No zone awareness:</strong> it doesn’t guarantee selected instances are balanced across availability zones</li><li><strong>No shuffling:</strong> the implementation is based on the hash ring and it selects N consecutive instances in the ring. This means that, instead of minimizing the likelihood that two tenants share the same instances, it emphasises it. In order to provide a good isolation between tenants, we want to minimize the chances that two tenants share the same instances.</li></ol><h3 id=goal>Goal</h3><p>The goal of this work is to fix “shuffling” and “zone-awareness” when building the subring for a given tenant, honoring the following properties:</p><ul><li><strong>Stability:</strong> given the same ring, the algorithm always generates the same subring for a given tenant, even across different machines</li><li><a href=https://en.wikipedia.org/wiki/Consistent_hashing><strong>Consistency:</strong></a> when the ring is resized, only n/m series are remapped on average (where n is the number of series and m is the number of replicas).</li><li><strong>Shuffling:</strong> probabilistically and for a large enough cluster, ensure every tenant gets a different set of instances, with a reduced number of overlapping instances between two tenants to improve failure isolation.</li><li><strong>Zone-awareness (balanced):</strong> the subring built for each tenant contains a balanced number of instances for each availability zone. Selecting the same number of instances in each zone is an important property because we want to preserve the balance of in-memory series across ingesters. Having less replicas in one zone will mean more load per node in this zone, which is something we want to avoid.</li></ul><h3 id=proposal>Proposal</h3><p>This proposal is based on <a href=https://aws.amazon.com/builders-library/workload-isolation-using-shuffle-sharding/>Amazon’s Shuffle Sharding article</a> and the algorithm has been inspired by shuffle sharding implementation in the <a href=https://github.com/awslabs/route53-infima/blob/master/src/main/java/com/amazonaws/services/route53/infima/SimpleSignatureShuffleSharder.java>AWS Route53 infima library</a>.</p><p>Given a tenant and a shard size S (number of instances to which tenant data/workload should be sharded to), we build a subring selecting N instances from each zone, where N = ceil(S / num of zones). The shard size S is required to be a multiple of the number of zones, in order to select an equal number of instances from each zone.</p><p>To do it, we <strong>treat each zone as a separate ring</strong> and select N unique instances from each zone. The instances selection process works as follow:</p><ol><li>Generate a seed based on the tenant ID</li><li>Initialise a pseudo random number generator with the tenant’s seed. The random generator must guarantee predictable numbers given the same input seed.</li><li>Generate a sequence of N random numbers, where N is the number of instances to select from the zone. Each random number is used as a “token” to look up instances in the ring. For each random number:</li><li>Lookup the instance holding that token in the ring</li><li>If the instance has not been previously selected, then pick it</li><li>If the instance was previously selected (we call this a “collision”), then continue walking the ring clockwise until we find an instance which has not been selected yet</li></ol><h3 id=guaranteed-properties>Guaranteed properties</h3><h4 id=stability>Stability</h4><p>The same tenant ID always generates the same seed. Given the same seed, the pseudo number random generator always generates the same sequence of numbers.</p><p>This guarantees that, given the same ring, we generate the same exact subring for a given tenant.</p><h4 id=consistency>Consistency</h4><p>The consistency property is honored by two aspects of the algorithm:</p><ol><li>The quantity of random numbers generated is always equal to the shard size S, even in case of “collisions”. A collision is when the instance holding the random token has already been picked and we need to select a different instance which has not been picked yet.</li><li>In case of collisions, we select the “next” instance continuing walking the ring instead of generating another random number</li></ol><h5 id=example-adding-an-instance-to-the-ring>Example adding an instance to the ring</h5><p>Let’s consider an initial ring with 3 instances and 1 zone (for simplicity):</p><ul><li>I1 - Tokens: 1, 8, 15</li><li>I2 - Tokens: 5, 11, 19</li><li>I3 - Tokens: 7, 13, 21</li></ul><p>With a replication factor = 2, the random sequence looks up:</p><ul><li>3 (I2)</li><li>6 (I1)</li></ul><p>Then we add a new instance and the <strong>updated ring</strong> is:</p><ul><li>I1 - Tokens: 1, 8, 15</li><li>I2 - Tokens: 5, 11, 19</li><li>I3 - Tokens: 7, 13, 21</li><li>I4 - Tokens: 4, 7, 17</li></ul><p>Now, let’s compare two different algorithms to solve collisions:</p><ul><li>Using the random generator:<br>Random sequence = 3 (<strong>I4</strong>), 6 (I4 - collision), 12 (<strong>I3</strong>)<br><strong>all instances are different</strong> (I4, I3)</li><li>Walking the ring:<br>Random sequence = 3 (<strong>I4</strong>), 6 (I4 - collision, next is <strong>I1</strong>)<br><strong>only 1 instance is different</strong> (I4, I1)</li></ul><h4 id=shuffling>Shuffling</h4><p>Unless when resolving collisions, the algorithm doesn’t walk the ring to find the next instances, but uses a sequence of random numbers. This guarantees instances are shuffled, between different tenants, when building the subring.</p><h4 id=zone-awareness>Zone-awareness</h4><p>We treat each zone as a separate ring and select an equal number of instances from each zone. This guarantees a fair balance of instances between zones.</p><h3 id=proof-of-concept>Proof of concept</h3><p>We’ve built a <a href=https://github.com/cortexproject/cortex/pull/3090>reference implementation</a> of the proposed algorithm, to test the properties described above.</p><p>In particular, we’ve observed that the <a href=https://github.com/cortexproject/cortex/pull/3090/files#diff-121ffce90aa9932f6b87ffd138e0f36aR281>actual distribution</a> of matching instances between different tenants is very close to the <a href=https://docs.google.com/spreadsheets/d/1FXbiWTXi6bdERtamH-IfmpgFq1fNL4GP_KX_yJvbRi4/edit>theoretical one</a>, as well as consistency and stability properties are both honored.</p></div></main></div></div><footer><div class="row td-box td-box--dark td-box--gradient td-box--height-auto text-white p-5"><div class="col-12 col-sm-4 pb-5 pb-sm-0"><img src=/images/cortex-stacked-white.png width=75px class="img-fluid float-left"></div><div class="col-12 col-sm-4 pb-5 pb-sm-0"><h6 class=font-weight-bold>Community</h6><ul class=list-unstyled><li><a href=https://slack.cncf.io class="text-reset text-white"><i class="fab fa-fw fa-slack"></i> Slack</a></li><li><a href=https://github.com/cortexproject/cortex class="text-reset text-white"><i class="fab fa-fw fa-github"></i> GitHub</a></li><li><a href=https://twitter.com/cortexmetrics class="text-reset text-white"><i class="fab fa-fw fa-twitter"></i> Twitter</a></li></ul></div><div class="col-12 col-sm-4"><h6 class=font-weight-bold>About</h6><p>Cortex is an OSS licensed project as Apache License 2.0</p></div></div><div class="row td-box td-box--dark td-box--gradient td-box--height-auto text-white p-5 text-center"><small class="col-12 text-center">© 2024 The Cortex Authors All Rights Reserved.<br>The Linux Foundation has registered trademarks and uses trademarks.
For a list of trademarks of The Linux Foundation, please see <a class="text-light alert-link" href=https://www.linuxfoundation.org/trademark-usage>Trademark Usage page</a>.</small></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA==" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script>
<script src=/js/main.min.91798a335c881f1b6b805085ba4aa22d1dbd2b0b18d105d05189fa104ddae350.js integrity="sha256-kXmKM1yIHxtrgFCFukqiLR29KwsY0QXQUYn6EE3a41A=" crossorigin=anonymous></script></body></html>