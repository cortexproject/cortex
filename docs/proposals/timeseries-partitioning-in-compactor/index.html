<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.101.0"><meta name=robots content="index, follow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Timeseries Partitioning in Compactor | Cortex</title><meta name=description content="
Author: @roystchiang
Reviewers:
Date: August 2022
Status: Proposed

Timeseries Partitioning in Compactor
Introduction
The compactor is a crucial …"><meta property="og:title" content="Timeseries Partitioning in Compactor"><meta property="og:description" content="Author: @roystchiang Reviewers: Date: August 2022 Status: Proposed Timeseries Partitioning in Compactor Introduction The compactor is a crucial component in Cortex responsible for deduplication of replicated data, and merging blocks across multiple time intervals together. This proposal will not go into great depth with why the compactor is necessary, but aims to focus on how to scale the compactor as a tenant grows within a Cortex cluster.
Problem and Requirements Cortex introduced horizontally scaling compactor which allows multiple compactors to compact blocks for a single tenant, sharded by time interval."><meta property="og:type" content="article"><meta property="og:url" content="/docs/proposals/timeseries-partitioning-in-compactor/"><meta property="og:image" content="/images/logo-twitter-card.jpg"><meta property="article:section" content="docs"><meta property="og:site_name" content="Cortex"><meta itemprop=name content="Timeseries Partitioning in Compactor"><meta itemprop=description content="Author: @roystchiang Reviewers: Date: August 2022 Status: Proposed Timeseries Partitioning in Compactor Introduction The compactor is a crucial component in Cortex responsible for deduplication of replicated data, and merging blocks across multiple time intervals together. This proposal will not go into great depth with why the compactor is necessary, but aims to focus on how to scale the compactor as a tenant grows within a Cortex cluster.
Problem and Requirements Cortex introduced horizontally scaling compactor which allows multiple compactors to compact blocks for a single tenant, sharded by time interval."><meta itemprop=wordCount content="4120"><meta itemprop=image content="/images/logo-twitter-card.jpg"><meta itemprop=keywords content><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/images/logo-twitter-card.jpg"><meta name=twitter:title content="Timeseries Partitioning in Compactor"><meta name=twitter:description content="Author: @roystchiang Reviewers: Date: August 2022 Status: Proposed Timeseries Partitioning in Compactor Introduction The compactor is a crucial component in Cortex responsible for deduplication of replicated data, and merging blocks across multiple time intervals together. This proposal will not go into great depth with why the compactor is necessary, but aims to focus on how to scale the compactor as a tenant grows within a Cortex cluster.
Problem and Requirements Cortex introduced horizontally scaling compactor which allows multiple compactors to compact blocks for a single tenant, sharded by time interval."><link rel=preload href=/scss/main.min.7bf6bc1e50fcd59f3acee825100658a2aadf711f0ea659c8297d6c58352c627c.css as=style><link href=/scss/main.min.7bf6bc1e50fcd59f3acee825100658a2aadf711f0ea659c8297d6c58352c627c.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SRR0DSREGX"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-SRR0DSREGX",{anonymize_ip:!1})}</script></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar navbar-nocover"><a id=cortex-logo class=navbar-brand href=/><span class=navbar-logo><svg xmlns="http://www.w3.org/2000/svg" role="img" viewBox="-17.92 -14.92 1191.84 462.84"><defs><style>.cls-1{fill:#fff}</style></defs><path d="M214.531 8.017C99.353 8.017 5.65 101.72 5.65 216.899S99.353 425.78 214.531 425.78s208.882-93.704 208.882-208.882S329.71 8.017 214.531 8.017zm0 408.558c-110.102.0-199.676-89.574-199.676-199.676S104.429 17.222 214.53 17.222 414.208 106.797 414.208 216.9 324.633 416.575 214.53 416.575z" class="cls-1"/><circle cx="327.452" cy="221.633" r="34.571" class="cls-1"/><circle cx="213.713" cy="353.584" r="34.571" class="cls-1"/><path d="M299.992 167.913l-59-56.05a34.578 34.578.0 10-4.343 4.34l57.828 54.937a60.158 60.158.0 00-27.168 49.123h-12.97l-23.456-67.02-26.055 64.718H175.73l-24.724 57.22-21.808-54.524-.063.025v-.586h-22.048a34.582 34.582.0 10-.275 6.138h18.005l25.97 64.925 28.977-67.06h29.207l21.51-53.424 19.503 55.725H267.5a60.173 60.173.0 0025.202 44.11l-56.52 56.52 4.34 4.338 57.492-57.492a60.155 60.155.0 101.977-105.963zm81.481 53.515a54.02 54.02.0 11-54.022-54.02 54.083 54.083.0 0154.022 54.02zm175.707 42.568q-8.797 8.178-24.405 8.177a34.858 34.858.0 01-17.095-3.965 33.188 33.188.0 01-11.643-10.529 46.374 46.374.0 01-6.566-14.99 71.134 71.134.0 01-2.105-17.341 86.99 86.99.0 011.982-18.706 46.804 46.804.0 016.565-15.98 34.028 34.028.0 0112.263-11.149q7.675-4.21 19.077-4.212 13.38.0 21.306 6.69 7.927 6.689 10.405 18.829h21.803a50.76 50.76.0 00-5.946-19.696 44.06 44.06.0 00-12.015-13.75 49.842 49.842.0 00-16.848-8.051 77.44 77.44.0 00-20.44-2.601q-15.114.0-26.509 5.326a52.935 52.935.0 00-18.952 14.617 62.165 62.165.0 00-11.273 21.8 94.013 94.013.0 00-3.717 26.883 86.195 86.195.0 003.84 26.386 57.783 57.783.0 0011.397 20.686 50.138 50.138.0 0018.829 13.38 66.766 66.766.0 0025.891 4.705q24.527.0 38.772-12.882 14.245-12.878 17.715-36.668h-21.556q-1.986 14.867-10.776 23.041zm157.44-87.828a56.338 56.338.0 00-19.447-14.244q-11.52-5.203-26.882-5.203-15.115.0-26.756 5.203a56.009 56.009.0 00-19.573 14.244 59.75 59.75.0 00-11.892 21.307 85.299 85.299.0 00-3.965 26.386 84.117 84.117.0 003.965 26.262 59.853 59.853.0 0011.892 21.183 54.61 54.61.0 0019.573 14.12q11.643 5.077 26.756 5.08 15.36.0 26.882-5.08a54.908 54.908.0 0019.447-14.12 59.95 59.95.0 0011.892-21.183 84.181 84.181.0 003.965-26.262 85.364 85.364.0 00-3.965-26.386 59.846 59.846.0 00-11.892-21.307zm-9.538 68.38a43.305 43.305.0 01-8.548 15.113 37.061 37.061.0 01-12.759 9.29 38.825 38.825.0 01-30.968.0 37.003 37.003.0 01-12.76-9.29 43.209 43.209.0 01-8.547-15.114 70.669 70.669.0 010-41.373 44.634 44.634.0 018.547-15.237 36.428 36.428.0 0112.76-9.415 38.826 38.826.0 0130.968.0 36.484 36.484.0 0112.76 9.415 44.735 44.735.0 018.547 15.237 70.624 70.624.0 010 41.373zm81.141-80.89q-11.147 7.434-18.83 23.041h-.493v-27.005h-19.82V287.78h21.057v-56.984a87.528 87.528.0 012.478-21.924 41.993 41.993.0 017.93-16.228 33.951 33.951.0 0114.368-10.158q8.919-3.468 21.555-3.468V156.72q-17.097-.493-28.245 6.937zm80.761-42.366h-21.06v38.402h-21.8v18.581h21.8v81.51a48.668 48.668.0 001.734 14.37 17.432 17.432.0 005.326 8.423 20.57 20.57.0 009.415 4.088 75.59 75.59.0 0013.999 1.115h16.104v-18.582h-9.664a70.335 70.335.0 01-8.05-.37 10.361 10.361.0 01-4.833-1.611 6.108 6.108.0 01-2.354-3.469 23.006 23.006.0 01-.617-5.946v-79.528h25.518v-18.581h-25.518zm148.522 60.452a56.135 56.135.0 00-18.085-17.962q-11.276-7.063-28.367-7.06a58.263 58.263.0 00-24.155 4.953A56.796 56.796.0 00925.82 175.55a63.949 63.949.0 00-12.51 21.058 77.064 77.064.0 00-4.461 26.758 102.521 102.521.0 004.338 27.004 58.87 58.87.0 0011.519 21.307 52.43 52.43.0 0018.953 13.873q11.272 4.954 26.632 4.955 21.8.0 36.173-10.901 14.364-10.898 18.58-32.455h-20.81q-2.73 12.635-11.272 18.829-8.549 6.198-21.927 6.195a43.577 43.577.0 01-18.085-3.468 35.417 35.417.0 01-12.636-9.291 36.127 36.127.0 01-7.184-13.38 50.746 50.746.0 01-1.981-15.98h95.879a102.07 102.07.0 00-2.107-24.526 71.064 71.064.0 00-9.415-23.784zm-84.357 29.73a43.81 43.81.0 013.219-13.999 37.354 37.354.0 017.433-11.52 34.013 34.013.0 0111.272-7.803 36.694 36.694.0 0114.74-2.85 36.062 36.062.0 0114.494 2.85 36.492 36.492.0 0111.398 7.68 36.107 36.107.0 017.68 11.52 43.253 43.253.0 013.345 14.122zm170.95 7.184 44.1-58.964h-25.271l-31.961 44.843-30.721-44.843h-27.006l44.595 60.698-48.063 67.389h25.518l35.677-53.019 35.676 53.019h27.006l-49.55-69.123z" class="cls-1"/></svg></span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/docs/><span class=active>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a href=https://twitter.com/cortexmetrics class="nav-link active"><span class=active><i class="fab fa-fw fa-twitter"></i> Twitter</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a href=https://github.com/cortexproject class="nav-link active"><span class=active><i class="fab fa-fw fa-github"></i> Github</span></a></li></ul></div><div class="navbar-nav d-none d-md-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.f92dcc95732c96d0a4c03dbc62873457.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><div id=content-mobile><form class="td-sidebar__search d-flex align-items-center"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.f92dcc95732c96d0a4c03dbc62873457.json data-offline-search-base-href=/ data-offline-search-max-results=10>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-section-nav aria-expanded=false aria-label="Toggle section navigation"></button></form></div><div id=content-desktop></div><nav class="collapse td-sidebar-nav" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docs-li><a href=/docs/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-docs><span>Documentation</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsgetting-started-li><a href=/docs/getting-started/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsgetting-started><span>Getting Started</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsarchitecture-li><a href=/docs/architecture/ title="Cortex Architecture" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsarchitecture><span>Architecture</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docsblocks-storage-li><a href=/docs/blocks-storage/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsblocks-storage><span>Blocks Storage</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsblocks-storagequerier-li><a href=/docs/blocks-storage/querier/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storagequerier><span>Querier</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsblocks-storagestore-gateway-li><a href=/docs/blocks-storage/store-gateway/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storagestore-gateway><span>Store-gateway</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsblocks-storagecompactor-li><a href=/docs/blocks-storage/compactor/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storagecompactor><span>Compactor</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsblocks-storageproduction-tips-li><a href=/docs/blocks-storage/production-tips/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storageproduction-tips><span>Production tips</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsblocks-storagebinary-index-header-li><a href=/docs/blocks-storage/binary-index-header/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storagebinary-index-header><span>Binary index-header</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsblocks-storagebucket-index-li><a href=/docs/blocks-storage/bucket-index/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storagebucket-index><span>Bucket Index</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsblocks-storagemigrate-cortex-cluster-from-chunks-to-blocks-li><a href=/docs/blocks-storage/migrate-cortex-cluster-from-chunks-to-blocks/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storagemigrate-cortex-cluster-from-chunks-to-blocks><span>Migrate Cortex cluster from chunks to blocks</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsblocks-storageconvert-long-term-storage-from-chunks-to-blocks-li><a href=/docs/blocks-storage/convert-long-term-storage-from-chunks-to-blocks/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storageconvert-long-term-storage-from-chunks-to-blocks><span>Convert long-term storage from chunks to blocks</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsblocks-storagemigrate-storage-from-thanos-and-prometheus-li><a href=/docs/blocks-storage/migrate-storage-from-thanos-and-prometheus/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storagemigrate-storage-from-thanos-and-prometheus><span>Migrate the storage from Thanos and Prometheus</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsblocks-storagelearn-more-li><a href=/docs/blocks-storage/learn-more/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storagelearn-more><span>Learn more</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docsconfiguration-li><a href=/docs/configuration/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsconfiguration><span>Configuration</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsconfigurationconfiguration-file-li><a href=/docs/configuration/configuration-file/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsconfigurationconfiguration-file><span>Configuration file</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsconfigurationarguments-li><a href=/docs/configuration/arguments/ title="Cortex Arguments" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsconfigurationarguments><span>Cortex Arguments Explained</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsconfigurationprometheus-frontend-li><a href=/docs/configuration/prometheus-frontend/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsconfigurationprometheus-frontend><span>Prometheus Frontend</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsconfigurationv1guarantees-li><a href=/docs/configuration/v1guarantees/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsconfigurationv1guarantees><span>v1.x Guarantees</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docsguides-li><a href=/docs/guides/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsguides><span>Guides</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidesrunning-cortex-on-kubernetes-li><a href=/docs/guides/running-cortex-on-kubernetes/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidesrunning-cortex-on-kubernetes><span>Running Cortex on Kubernetes</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidesgetting-started-with-gossiped-ring-li><a href=/docs/guides/getting-started-with-gossiped-ring/ title="Getting started with gossiped ring" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidesgetting-started-with-gossiped-ring><span>Getting started with a gossip ring cluster</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidesalertmanager-configuration-li><a href=/docs/guides/alertmanager-configuration/ title="Configuring Notification using Cortex Alertmanager" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidesalertmanager-configuration><span>Alertmanager configuration</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidesauth-li><a href=/docs/guides/auth/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidesauth><span>Authentication and Authorisation</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidescapacity-planning-li><a href=/docs/guides/capacity-planning/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidescapacity-planning><span>Capacity Planning</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidesruler-sharding-li><a href=/docs/guides/ruler-sharding/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidesruler-sharding><span>Config for horizontally scaling the Ruler</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidesha-pair-handling-li><a href=/docs/guides/ha-pair-handling/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidesha-pair-handling><span>Config for sending HA Pairs data to Cortex</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidesencryption-at-rest-li><a href=/docs/guides/encryption-at-rest/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidesencryption-at-rest><span>Encryption at Rest</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidesingesters-rolling-updates-li><a href=/docs/guides/ingesters-rolling-updates/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidesingesters-rolling-updates><span>Ingesters rolling updates</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidesingesters-scaling-up-and-down-li><a href=/docs/guides/ingesters-scaling-up-and-down/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidesingesters-scaling-up-and-down><span>Ingesters scaling up and down</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidesoverrides-exporter-li><a href=/docs/guides/overrides-exporter/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidesoverrides-exporter><span>Overrides Exporter</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidestls-li><a href=/docs/guides/tls/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidestls><span>Securing communication between Cortex components with TLS</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidessecurity-li><a href=/docs/guides/security/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidessecurity><span>Security</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidesshuffle-sharding-li><a href=/docs/guides/shuffle-sharding/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidesshuffle-sharding><span>Shuffle Sharding</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidestracing-li><a href=/docs/guides/tracing/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidestracing><span>Tracing</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguideszone-aware-replication-li><a href=/docs/guides/zone-aware-replication/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguideszone-aware-replication><span>Zone Aware Replication</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguideslimitations-li><a href=/docs/guides/limitations/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguideslimitations><span>Limitations</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsguidesglossary-li><a href=/docs/guides/glossary/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsguidesglossary><span>Glossary</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsapi-li><a href=/docs/api/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsapi><span>HTTP API</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docsoperations-li><a href=/docs/operations/ title="Operating Cortex" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsoperations><span>Operations</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsoperationsquery-auditor-li><a href=/docs/operations/query-auditor/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsoperationsquery-auditor><span>Query Auditor (tool)</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsoperationsquery-tee-li><a href=/docs/operations/query-tee/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsoperationsquery-tee><span>Query Tee (service)</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsoperationsrequests-mirroring-to-secondary-cluster-li><a href=/docs/operations/requests-mirroring-to-secondary-cluster/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsoperationsrequests-mirroring-to-secondary-cluster><span>Requests mirroring to secondary cluster</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsoperationsscaling-query-frontend-li><a href=/docs/operations/scaling-query-frontend/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsoperationsscaling-query-frontend><span>Scaling the Query Frontend</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docscase-studies-li><a href=/docs/case-studies/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docscase-studies><span>Case Studies</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docscase-studiesgojek-li><a href=/docs/case-studies/gojek/ title="How Gojek Is Leveraging Cortex to Keep Up with Its Ever-Growing Scale" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscase-studiesgojek><span>Gojek</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docscase-studiesrewe-digital-li><a href=/docs/case-studies/rewe-digital/ title="How Cortex helped REWE digital ensure stability while scaling services during the Covid-19 pandemic" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscase-studiesrewe-digital><span>REWE digital</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docscase-studiesbuoyant-cloud-li><a href=/docs/case-studies/buoyant-cloud/ title="Buoyant Cloud and Cortex: Standing on the shoulders of Linkerd and Prometheus" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscase-studiesbuoyant-cloud><span>Buoyant Cloud</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docsproposals-li><a href=/docs/proposals/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsproposals><span>Proposals</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsproposalsblocks-storage-bucket-index-li><a href=/docs/proposals/blocks-storage-bucket-index/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalsblocks-storage-bucket-index><span>Blocks storage bucket index</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsproposalsblocks-storage-sharding-li><a href=/docs/proposals/blocks-storage-sharding/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalsblocks-storage-sharding><span>Blocks storage sharding</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsproposalscross-tenant-query-federation-li><a href=/docs/proposals/cross-tenant-query-federation/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalscross-tenant-query-federation><span>Cross-Tenant Query Federation</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsproposalstenant-deletion-li><a href=/docs/proposals/tenant-deletion/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalstenant-deletion><span>Deletion of Tenant Data from Blocks Storage</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsproposalsdocumentation-versioning-li><a href=/docs/proposals/documentation-versioning/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalsdocumentation-versioning><span>Documentation Versioning</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsproposalsgeneralize-modules-li><a href=/docs/proposals/generalize-modules/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalsgeneralize-modules><span>Generalize Modules Service to make it extensible</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsproposalshttp-api-design-li><a href=/docs/proposals/http-api-design/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalshttp-api-design><span>HTTP API Design</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsproposalsingesters-migration-li><a href=/docs/proposals/ingesters-migration/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalsingesters-migration><span>Migrating ingesters from chunks to blocks and back.</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsproposalsparallel-compaction-li><a href=/docs/proposals/parallel-compaction/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalsparallel-compaction><span>Parallel Compaction by Time Interval</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsproposalstenant-retention-li><a href=/docs/proposals/tenant-retention/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalstenant-retention><span>Retention of Tenant Data from Blocks Storage</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsproposalsring-multikey-li><a href=/docs/proposals/ring-multikey/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalsring-multikey><span>Ring Multikey</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsproposalsruler-ha-li><a href=/docs/proposals/ruler-ha/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalsruler-ha><span>Ruler HA</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsproposalsruler-tenant-federation-li><a href=/docs/proposals/ruler-tenant-federation/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalsruler-tenant-federation><span>Ruler Tenant Federation</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsproposalsscalable-alertmanager-li><a href=/docs/proposals/scalable-alertmanager/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalsscalable-alertmanager><span>Scalable Alertmanager</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsproposalsscalable-query-frontend-li><a href=/docs/proposals/scalable-query-frontend/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalsscalable-query-frontend><span>Scalable Query Frontend</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsproposalsshuffle-sharding-and-zone-awareness-li><a href=/docs/proposals/shuffle-sharding-and-zone-awareness/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalsshuffle-sharding-and-zone-awareness><span>Shuffle sharding and zone awareness</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsproposalsshuffle-sharding-on-the-read-path-li><a href=/docs/proposals/shuffle-sharding-on-the-read-path/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalsshuffle-sharding-on-the-read-path><span>Shuffle sharding on the read path</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsproposalssupport-metadata-api-li><a href=/docs/proposals/support-metadata-api/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalssupport-metadata-api><span>Support metadata API</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsproposalsblock-storage-time-series-deletion-li><a href=/docs/proposals/block-storage-time-series-deletion/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalsblock-storage-time-series-deletion><span>Time Series Deletion from Blocks Storage</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-docsproposalstimeseries-partitioning-in-compactor-li><a href=/docs/proposals/timeseries-partitioning-in-compactor/ class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-docsproposalstimeseries-partitioning-in-compactor><span class=td-sidebar-nav-active-item>Timeseries Partitioning in Compactor</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docscontributing-li><a href=/docs/contributing/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docscontributing><span>Contributing</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docscontributinggovernance-li><a href=/docs/contributing/governance/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscontributinggovernance><span>Governance</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docscontributingdesign-patterns-and-code-conventions-li><a href=/docs/contributing/design-patterns-and-code-conventions/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscontributingdesign-patterns-and-code-conventions><span>Design patterns and Code conventions</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docscontributinghow-to-run-the-website-locally-li><a href=/docs/contributing/how-to-run-the-website-locally/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscontributinghow-to-run-the-website-locally><span>How to run the website locally</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docscontributinghow-to-upgrade-golang-version-li><a href=/docs/contributing/how-to-upgrade-golang-version/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscontributinghow-to-upgrade-golang-version><span>How to upgrade Golang version</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docscontributinghow-integration-tests-work-li><a href=/docs/contributing/how-integration-tests-work/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscontributinghow-integration-tests-work><span>How integration tests work</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docscontributinghow-to-update-the-build-image-li><a href=/docs/contributing/how-to-update-the-build-image/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscontributinghow-to-update-the-build-image><span>How to update the build image</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docscontributinghow-to-add-a-maintainer-li><a href=/docs/contributing/how-to-add-a-maintainer/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscontributinghow-to-add-a-maintainer><span>How to add a maintainer</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsroadmap-li><a href=/docs/roadmap/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsroadmap><span>Roadmap</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschangelog-li><a href=/docs/changelog/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschangelog><span>Changelog</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscode-of-conduct-li><a href=/docs/code-of-conduct/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscode-of-conduct><span>Code of Conduct</span></a></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/cortexproject/cortex/edit/master/docs/proposals/timeseries-partitioning-in-compactor.md target=_blank><i class="fa fa-edit fa-fw"></i> Edit this page</a>
<a href="https://github.com/cortexproject/cortex/issues/new?title=Timeseries%20Partitioning%20in%20Compactor" target=_blank><i class="fab fa-github fa-fw"></i> Create documentation issue</a>
<a href=https://github.com/cortexproject/cortex/issues/new target=_blank><i class="fas fa-tasks fa-fw"></i> Create project issue</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#timeseries-partitioning-in-compactor>Timeseries Partitioning in Compactor</a></li><li><a href=#introduction>Introduction</a></li><li><a href=#problem-and-requirements>Problem and Requirements</a></li><li><a href=#design>Design</a><ul><li><a href=#partitioning-strategy>Partitioning strategy</a></li><li><a href=#determining-overlapping-blocks>Determining overlapping blocks</a></li><li><a href=#planning-the-compaction>Planning the compaction</a></li><li><a href=#compaction>Compaction</a></li><li><a href=#compaction-workflow>Compaction Workflow</a></li><li><a href=#clean-up-workflow>Clean up Workflow</a></li></ul></li><li><a href=#performance>Performance</a></li><li><a href=#alternatives-considered>Alternatives Considered</a><ul><li><a href=#dynamic-number-of-partition>Dynamic Number of Partition</a></li><li><a href=#consistent-hashing>Consistent Hashing</a></li><li><a href=#partition-by-metric-name>Partition by metric name</a></li></ul></li><li><a href=#architecture>Architecture</a><ul><li><a href=#planning>Planning</a></li><li><a href=#clean-up>Clean up</a></li></ul></li><li><a href=#changes-required-in-dependencies>Changes Required in Dependencies</a><ul><li><a href=#partitioning-during-compaction-time>Partitioning during compaction time</a></li><li><a href=#source-block-checking>Source block checking</a></li></ul></li><li><a href=#work-plan>Work Plan</a></li><li><a href=#appendix>Appendix</a><ul><li><a href=#risks>Risks</a></li><li><a href=#frequently-asked-questions>Frequently Asked Questions</a></li><li><a href=#compaction-partitioning-examples>Compaction Partitioning Examples</a></li></ul></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class=td-breadcrumbs><ol class=breadcrumb><li class=breadcrumb-item><a href=/docs/>Documentation</a></li><li class=breadcrumb-item><a href=/docs/proposals/>Proposals</a></li><li class="breadcrumb-item active" aria-current=page><a href=/docs/proposals/timeseries-partitioning-in-compactor/ aria-disabled=true class="btn-link disabled">Timeseries Partitioning in Compactor</a></li></ol></nav><div class=td-content><h1>Timeseries Partitioning in Compactor</h1><header class=article-meta></header><ul><li>Author: @roystchiang</li><li>Reviewers:</li><li>Date: August 2022</li><li>Status: Proposed</li></ul><h2 id=timeseries-partitioning-in-compactor>Timeseries Partitioning in Compactor</h2><h2 id=introduction>Introduction</h2><p>The compactor is a crucial component in Cortex responsible for deduplication of replicated data, and merging blocks across multiple time intervals together. This proposal will not go into great depth with why the compactor is necessary, but aims to focus on how to scale the compactor as a tenant grows within a Cortex cluster.</p><h2 id=problem-and-requirements>Problem and Requirements</h2><p>Cortex introduced horizontally scaling compactor which allows multiple compactors to compact blocks for a single tenant, sharded by time interval. The compactor is capable of compacting multiple smaller blocks into a larger block, to reduce the duplicated information in index. The following is an illustration of how the shuffle sharding compactor works, where each arrow represents a single compaction that can be carried out independently.
<img src=/images/proposals/parallel-compaction-grouping.png alt="Current Implementation"></p><p>However, if the tenant is sending unique timeseries, the compaction process does not help with reducing the index size. Furthermore, this scaling of parallelism by time interval is not sufficient for a tenant with hundreds of millions of timeseries, as more timeseries means longer compaction time.</p><p>Currently, the compactor is bounded by the 64GB index size, and having a compaction that takes days to complete simply is not sustainable. This time includes the time to download the blocks, merging of the timeseries, writing to disk, and finally uploading to object storage.</p><p>The compactor is able to compact up to 400M timeseries within 12 hours, and will fail with the error of index exceeding 64GB. Depending on the number of labels and the size of labels, one might reach the 64GB limit sooner. We need a solution that is capable of:</p><ul><li>handling the 64GB index limit</li><li>reducing the overall compaction time<ul><li>downloading the data in smaller batches</li><li>reducing the time required to compact</li></ul></li></ul><h2 id=design>Design</h2><p>A reminder of what a Prometheus TSDB is composed of: an index and chunks. An index is a mapping of timeseries to the chunks, so we can do a direct lookup in the chunks. Each timeseries is effectively a set of labels, mapped to a list of &lt;timestamp, value> pair. This proposal focuses on partitioning of the timeseries.</p><h3 id=partitioning-strategy>Partitioning strategy</h3><p>The compactor will compact a overlapping time-range into multiple sub-blocks, instead of a single block. Cortex can determine which partition a single timeseries should go into by applying a hash to the timeseries label, and taking the modulo of the hash by the number of partition. This guarantees that with same number of partition, the same timeseries will go into the same partition.</p><p><code>partitionId = Hash(timeseries label) % number of partition</code></p><p>The number of partition will be determined automatically, via a configured <code>multiplier</code>. This <code>multiplier</code> factor allows us to group just a subset of the blocks together to achieve the same deduplication factor as having all the blocks. Using a <code>multiplier</code> of 2 as an example, we can do grouping for partition of 2, 4 and 8. We’ll build on the actual number of partition determination in a later section.</p><h3 id=determining-overlapping-blocks>Determining overlapping blocks</h3><p>In order to reduce the amount of time spent downloading blocks, and iterating through the index to filter out unrelated timeseries, we can do smart grouping of the blocks.</p><p><img src=/images/proposals/timeseries-partitioning-in-compactor-modulo-partition.png alt="Modulo Partitioning"></p><p>Given that we are always multiplying the number of partition by the <code>multiplier</code> factor, we can deduce from the modulo which partition could contain overlapping result</p><pre tabindex=0><code>Given a hash N, if N % 8 == 7, then N % 4 must be 3
Given a hash N, if N % 8 == 3, then N % 4 must be 3
Given a hash N, if N % 8 == 4, then N % 4 must be 0
Given a hash N, if N % 8 == 0, then N % 4 must be 0
</code></pre><p>Hence it is safe to group blocks with <code>N % 8 == 7</code> with <code>N % 8 == 3 </code>together with <code>N % 4 == 3</code> together, and we are sure that other blocks won’t contain the same timeseries. We also know that if <code>N % 8 == 0</code>, then we don’t need to download blocks where <code>N % 4 == 1</code> or <code>N % 4 == 2</code>
Given partition count and partition id, we can immediately find out which blocks are required. Using the above modulo example, we get the following partitiong mapping.</p><p><img src=/images/proposals/timeseries-partitioning-in-compactor-partitions.png alt=Partition></p><h3 id=planning-the-compaction>Planning the compaction</h3><p>The shuffle sharding compactor introduced additional logic to group blocks by distinct time intervals. It can also sum up the sizes of all indices to determine how many shards are required in total. Using the above example again, and assuming that each block has an index of 30GB, the sum is 30GB * 14 = 420GB, which needs to be at least 7, since maximum index size is 64GB. Using the <code>multiplier</code> factor, it will be rounded up to 8.</p><p>Now the planner knows the resulting compaction will have 8 partitions, it can start planning out which groups of blocks can go into a single compaction group. Given that we need 8 partitions in total, the planner will go through the process above to find out what blocks are necessary. Using the above example again, but we have distinct time intervals, T1, T2, and T3. T1 has 2 partitions, T2 has 4 partitions, and T3 has 8 partitions, and we want to produce T1-T3 blocks
<img src=/images/proposals/timeseries-partitioning-in-compactor-grouping.png alt=Grouping></p><pre tabindex=0><code>Compaction Group 1-8
T1 - Partition 1-2
T2 - Partition 1-4
T3 - Partition 1-8

Compaction Group 2-8
T1 - Partition 2-2
T2 - Partition 2-4
T3 - Partition 2-8

Compaction Group 3-8
T1 - Partition 1-2
T2 - Parittion 3-4
T3 - Partition 3-8

Compaction Group 4-8
T1 - Partition 2-2
T2 - Partition 4-4
T3 - Partition 4-8

Compaction Group 5-8
T1 - Partition 1-2
T2 - Partition 1-4
T3 - Partition 5-8

Compaction Group 6-8
T1 - Partition 2-2
T2 - Partition 2-4
T3 - Partition 6-8

Compaction Group 7-8
T1 - Partition 1-2
T2 - Partition 3-4
T3 - Partition 7-8

Compaction Group 8-8
T1 - Partition 2-2
T2 - Partition 4-4
T3 - Partition 8-8
</code></pre><p><code>T1 - Partition 1-2</code> is used in multiple compaction groups, and the following section will describe how the compaction avoids duplicate timeseries in the resulting blocks</p><h3 id=compaction>Compaction</h3><p>Now that the planner has produced a compaction plan for the T1-T3 compaction groups, the compactor can start downloading the necessary blocks. Using compaction group 1-8 from above as example.
<img src=/images/proposals/timeseries-partitioning-in-compactor-compact.png alt=Grouping>
T1 - Partition 1-2 was created with hash % 2 == 0, and in order to avoid having duplication information in blocks produced by compaction group 3-8, compaction group 5-8, and compaction group 7-8, we need apply the filter the <code>%8 == 0</code> hash, as that’s the hash of the highest partition count.</p><h3 id=compaction-workflow>Compaction Workflow</h3><ol><li>Compactor initializes Grouper and Planner.</li><li>Compactor retrieves block&rsquo;s meta.json and call Grouper to group blocks for compaction.</li><li>Grouper generates partitioned compaction groups:<ol><li>Grouper groups source blocks into unpartitioned groups.</li><li>For each unpartitioned group:<ol><li>Generates partitioned compaction group ID which is hash of min and max time of result block.</li><li>If the ID exists under the tenant directory in block storage, continue on next unpartitioned group.</li><li>Calculates number of partitions. Number of partitions indicates how many partitions one unpartitioned group would be partitioned into based on the total size of indices and number of time series from each source blocks in the unpartitioned group.</li><li>Assign source blocks into each partition with partition ID (value is in range from 0 to number_of_partitions - 1). Note that one source block could be used in multiple partitions (explanation in <a href=#planning-the-compaction>Planning the compaction</a> and <a href=#compaction>Compaction</a>). So multiple partition ID could be assigned to same source block. Check more partitioning examples in <a href=#compaction-partitioning-examples>Compaction Partitioning Examples</a></li><li>Generates partitioned compaction group that indicates which partition ID each blocks got assigned.</li><li>Partitioned compaction group information would be stored in block storage under the tenant directory it belongs to and the stored file can be picked up by cleaner later. Partitioned compaction group information contains partitioned compaction group ID, number of partitions, list of partitions which has partition ID and list of source blocks.</li><li>Store partitioned compaction group ID in block storage under each blocks&rsquo; directory that are used by the generated partitioned compaction group.</li></ol></li></ol></li><li>Grouper returns partitioned compaction groups to Compactor. Each returned group would have partition ID, number of partitions, and list of source blocks in memory.</li><li>Compactor iterates over each partitioned compaction group. For each iteration, calls Planner to make sure the group is ready for compaction.</li><li>Planner collects partitioned compaction group which is ready for compaction.<ol><li>For each partitions in the group and for each blocks in the partition:<ol><li>Make sure all source blocks fit within the time range of the group.</li><li>Make sure each source block with assigned partition IDs is currently not used by another ongoing compaction. This could utilize visit marker file that is introduced in #4805 by expanding it for each partition ID of the source block.</li><li>If all blocks in the partition are ready to be compacted,<ol><li>mark status of those blocks with assigned partition ID as <code>pending</code>.</li><li>The status information of each partition ID would be stored in block storage under the corresponding block directory in order for cleaner to pick it up later.</li></ol></li><li>If not all blocks in the partition are ready, continue on next partition</li></ol></li></ol></li><li>Return all ready partitions to Compactor.</li><li>Compactor starts compacting partitioned blocks. Once compaction completed, Compactor would mark status of all blocks along with assigned partition ID in the group as <code>completed</code>. Compactor should use partitioned compaction group ID to retrieve partitioned compaction group information from block storage to get all partition IDs assigned to each block. Then, retrieve status information of each partition ID this assigned to block under current block directory in block storage. If all assigned partition ID of the block have status set to <code>completed</code>, upload deletion marker for this block. Otherwise, no deletion marker would be uploaded.</li></ol><h3 id=clean-up-workflow>Clean up Workflow</h3><p>Cleaner would periodically check any tenants having deletion marker. If there is a deletion marker for the tenant, Cleaner should remove all blocks and then clean up other files including partitioned group information files after tenant clean up delay. If there is no deletion marker for tenant, Clean should scan any source blocks having a deletion marker. If there is a deletion marker for the block, Cleaner should delete it.</p><h2 id=performance>Performance</h2><p>Currently a 400M timeseries takes 12 hours to compact, without taking block download into consideration. If we have a partition count of 2, we can reduce this down to 6 hours, and a partition count of 10 is 3 hours. The scaling is not linear, and I’m still attempting to find out why. The initial result is promising enough to continue though.</p><h2 id=alternatives-considered>Alternatives Considered</h2><h3 id=dynamic-number-of-partition>Dynamic Number of Partition</h3><p>We can also increase/decrease the number of partition without needing the <code>multiplier</code> factor. However, if a tenant is sending highly varying number of timeseries or label size, the index size can be very different, resulting in highly dynamic number of partitions. To perform deduplication, we’ll end up having to download all the sub-blocks, and it can be inefficient as less parallelization can be done, and we will spend more time downloading all the unnecessary blocks.</p><h3 id=consistent-hashing>Consistent Hashing</h3><p>Jump consistent hash, rendezvous hashing, and other consistent hashing are great algorithms to avoid
reshuffling of data when introducing/removing partitions on the fly. However, it does not bring much of a benefit when determining which partition contains the same timeseries, which we need to deduplication of index.</p><h3 id=partition-by-metric-name>Partition by metric name</h3><p>It is likely that when a query comes, a tenant is interested in an aggregation of a single metric, across all label names. The compactor can partition by metric name, so that all timeseries with the same name will go into the same block. However, this can result in very uneven partitioning.</p><h2 id=architecture>Architecture</h2><h3 id=planning>Planning</h3><p>The shuffle partitioning compactor introduced a planner logic, which we can extend on. This planner is responsible for grouping the blocks together by time interval, in order to compact blocks in parallel. The grouper can also determine the number of partition by looking at the sum of index file sizes. In addition, it can also do the grouping of the sub-blocks together, so we can achieve even higher parallelism.</p><h3 id=clean-up>Clean up</h3><p>Cortex compactor cleans up obsolete source blocks by looking at a deletion marker. The current architecture does not have the problem of having a single source block involved in multiple compaction. However, this proposal is able to achieve higher parallelism than before, hence it is possible that a source block is involved multiple times. Changes needs to be made on the compactor regarding how many plans a particular blocked is involved in, and determining when a block is safe to be deleted.</p><h2 id=changes-required-in-dependencies>Changes Required in Dependencies</h2><h3 id=partitioning-during-compaction-time>Partitioning during compaction time</h3><p>Prometheus exposes the possibility to pass in a custom <a href=https://github.com/prometheus/prometheus/blob/a1fcfe62dbe82c6292214f50ee91337566b0d61b/tsdb/compact.go#L148>mergeFunc</a>. This allows us to plug in the custom partitioning strategy. However, the mergeFunc is only called when the timeseries is successfully replicated to at least 3 replicas, meaning that we’ll produce duplicate timeseries across blocks if the data is only replicated once. To work around the issue, we can propose Prometheus to allow the configuration of the <a href=https://github.com/prometheus/prometheus/blob/a1fcfe62dbe82c6292214f50ee91337566b0d61b/tsdb/compact.go#L757>MergeChunkSeriesSet</a>.</p><h3 id=source-block-checking>Source block checking</h3><p>Cortex uses Thanos’s compactor logic, and it has a check to make sure the source blocks of the input blocks do not overlap. Meaning that if BlockA is produced from BlockY, and BlockB is also produced from BlockY, it will halt. This is not desirable for us, since partitioning by timeseries means the same source blocks will produce multiple blocks. Reason for having this check in Thanos is supposed to prevent having duplicate chunks, but the change was introduced without knowing whether it will actually help. We’ll need to introduce a change in Thanos to disable this check, or start using Thanos compactor as a library instead of a closed box.</p><h2 id=work-plan>Work Plan</h2><ul><li>Performance test the impact on query of having multiple blocks</li><li>Get real data on the efficiency of modulo operator for partitioning</li><li>Get the necessary changes in Prometheus approved and merged</li><li>Get the necessary changes in Thanos approved and merged</li><li>Implement the number of partition determination in group</li><li>Implement the grouper logic in Cortex</li><li>Implement the clean up logic in Cortex</li><li>Implement the partitioning strategy in Cortex, passed to Prometheus</li><li>Produce the partitioned blocks</li></ul><h2 id=appendix>Appendix</h2><h3 id=risks>Risks</h3><ul><li>Is taking the modulo of the hash sufficient to produce a good distribution of partitions?</li><li>What’s the effect of having too many blocks for the same time range?</li></ul><h3 id=frequently-asked-questions>Frequently Asked Questions</h3><ul><li>Are we able to decrease the number of partition?<ul><li>Using partitions of 2, and 4, and 8 as example</li></ul></li></ul><pre tabindex=0><code>T1 partition 1 - Hash(timeseries label) % 2 == 0
T1 partition 2 - Hash(timeseries label) % 2 == 1

T2 partition 1 - Hash(timeseries label) % 4 == 0
T2 partition 2 - Hash(timeseries label) % 4 == 1
T2 partition 3 - Hash(timeseries label) % 4 == 2
T2 partition 4 - Hash(timeseries label) % 4 == 3

T3 partition 1 - Hash(timeseries label) % 8 == 0
T3 partition 2 - Hash(timeseries label) % 8 == 1
T3 partition 3 - Hash(timeseries label) % 8 == 2
T3 partition 4 - Hash(timeseries label) % 8 == 3
T3 partition 5 - Hash(timeseries label) % 8 == 4
T3 partition 6 - Hash(timeseries label) % 8 == 5
T3 partition 7 - Hash(timeseries label) % 8 == 6
T3 partition 8 - Hash(timeseries label) % 8 == 7

We are free to produce a resulting timerange T1-T3, without
having to download all 14 blocks in a single compactor

If T1-T3 can fit inside 4 partitions, we can do the following grouping

T1 partition 1 - Hash(timeseries label) % 2 == 0 &amp;&amp; % 4 == 0
T2 partition 1 - Hash(timeseries label) % 4 == 0 &amp;&amp;
T3 partition 1 - Hash(timeseries label) % 8 == 0
T3 partition 5 - Hash(timeseries label) % 8 == 4

T1 partition 2 - Hash(timeseries label) % 2 == 1 &amp;&amp; % 4 == 01
T2 partition 2 - Hash(timeseries label) % 4 == 1
T3 partition 2 - Hash(timeseries label) % 8 == 1
T3 partition 7 - Hash(timeseries label) % 8 == 5

T1 partition 1 - Hash(timeseries label) % 2 == 0 &amp;&amp; % 4 == 2
T2 partition 3 - Hash(timeseries label) % 4 == 2
T3 partition 3 - Hash(timeseries label) % 8 == 2
T3 partition 7 - Hash(timeseries label) % 8 == 6

T1 partition 2 - Hash(timeseries label) % 2 == 1 &amp;&amp; % 4 == 3
T2 partition 4 - Hash(timeseries label) % 4 == 3
T3 partition 4 - Hash(timeseries label) % 8 == 3
T3 partition 8 - Hash(timeseries label) % 8 == 7

If T1-T3 can fit inside 16 partitions, we can do the same grouping, and hash on top

T1 partition 1 - Hash(timeseries label) % 2 == 0 &amp;&amp; % 8 == 0
T2 partition 1 - Hash(timeseries label) % 4 == 0 &amp;&amp; % 8 == 0
T3 partition 1 - Hash(timeseries label) % 8 == 0

T1 partition 2 - Hash(timeseries label) % 2 == 1  &amp;&amp; % 8 == 1
T2 partition 2 - Hash(timeseries label) % 4 == 1  &amp;&amp; % 8 == 1
T3 partition 2 - Hash(timeseries label) % 8 == 1

T1 partition 1 - Hash(timeseries label) % 2 == 0 &amp;&amp; % 8 == 2
T2 partition 3 - Hash(timeseries label) % 4 == 2 &amp;&amp; % 8 == 2
T3 partition 3 - Hash(timeseries label) % 8 == 2

T1 partition 2 - Hash(timeseries label) % 2 == 1 &amp;&amp; % 8 == 3
T2 partition 4 - Hash(timeseries label) % 4 == 3 &amp;&amp; % 8 == 3
T3 partition 4 - Hash(timeseries label) % 8 == 3

T1 partition 1 - Hash(timeseries label) % 2 == 0 &amp;&amp; % 8 == 4
T2 partition 1 - Hash(timeseries label) % 4 == 0 &amp;&amp; % 8 == 4
T3 partition 5 - Hash(timeseries label) % 8 == 4

T1 partition 2 - Hash(timeseries label) % 2 == 1 &amp;&amp; % 8 == 5
T2 partition 2 - Hash(timeseries label) % 4 == 1 &amp;&amp; % 8 == 5
T3 partition 6 - Hash(timeseries label) % 8 == 5

T1 partition 1 - Hash(timeseries label) % 2 == 0 &amp;&amp;  % 8 == 6
T2 partition 3 - Hash(timeseries label) % 4 == 2 &amp;&amp;  % 8 == 6
T3 partition 7 - Hash(timeseries label) % 8 == 6

T1 partition 2 - Hash(timeseries label) % 2 == 1 &amp;&amp; % 8 == 7
T2 partition 4 - Hash(timeseries label) % 4 == 3 &amp;&amp; % 8 == 7
T3 partition 8 - Hash(timeseries label) % 8 == 7
</code></pre><h3 id=compaction-partitioning-examples>Compaction Partitioning Examples</h3><h4 id=scenario-all-source-blocks-were-compacted-by-partitioning-compaction-idea-case>Scenario: All source blocks were compacted by partitioning compaction (Idea case)</h4><p>All source blocks were previously compacted through partitioning compaction. In this case for each time range, the number of blocks belong to same time range would be 2^x if multiplier is set to 2.</p><pre tabindex=0><code>Time ranges:
T1, T2, T3

Source blocks:
T1: B1, B2
T2: B3, B4, B5, B6
T3: B7, B8, B9, B10, B11, B12, B13, B14

Total indices size of all source blocks:
200G
</code></pre><p>Number of Partitions = (200G / 64G = 3.125) => round up to next 2^x = 4</p><p>Partitioning:</p><ul><li>For T1, there are only 2 blocks which is &lt; 4. So<ul><li>B1 (index 0 in the time range) can be grouped with other blocks having N % 4 == 0 or 2. Because 0 % 2 == 0.</li><li>B2 (index 1 in the time range) can be grouped with other blocks having N % 4 == 1 or 3. Because 1 % 2 == 1.</li></ul></li><li>For T2,<ul><li>B3 (index 0 in the time range) can be grouped with other blocks having N % 4 == 0.</li><li>B4 (index 1 in the time range) can be grouped with other blocks having N % 4 == 1.</li><li>B5 (index 2 in the time range) can be grouped with other blocks having N % 4 == 2.</li><li>B6 (index 3 in the time range) can be grouped with other blocks having N % 4 == 3.</li></ul></li><li>For T3,<ul><li>B7 (index 0 in the time range) can be grouped with other blocks having N % 4 == 0.</li><li>B8 (index 1 in the time range) can be grouped with other blocks having N % 4 == 1.</li><li>B9 (index 2 in the time range) can be grouped with other blocks having N % 4 == 2.</li><li>B10 (index 3 in the time range) can be grouped with other blocks having N % 4 == 3.</li><li>B11 (index 4 in the time range) can be grouped with other blocks having N % 4 == 0.</li><li>B12 (index 5 in the time range) can be grouped with other blocks having N % 4 == 1.</li><li>B13 (index 6 in the time range) can be grouped with other blocks having N % 4 == 2.</li><li>B14 (index 7 in the time range) can be grouped with other blocks having N % 4 == 3.</li></ul></li></ul><p>Partitions in Partitioned Compaction Group:</p><ul><li>Partition ID: 0<br>Number of Partitions: 4<br>Blocks: B1, B3, B7, B11</li><li>Partition ID: 1<br>Number of Partitions: 4<br>Blocks: B2, B4, B8, B12</li><li>Partition ID: 2<br>Number of Partitions: 4<br>Blocks: B1, B5, B9, B13</li><li>Partition ID: 3<br>Number of Partitions: 4<br>Blocks: B2, B6, B10, B14</li></ul><hr><h4 id=scenario-all-source-blocks-are-level-1-blocks>Scenario: All source blocks are level 1 blocks</h4><p>All source blocks are level 1 blocks. Since number of level 1 blocks in one time range is not guaranteed to be 2^x, all blocks need to be included in each partition.</p><pre tabindex=0><code>Time ranges:
T1

Source blocks:
T1: B1, B2, B3

Total indices size of all source blocks:
100G
</code></pre><p>Number of Partitions = (100G / 64G = 1.5625) => round up to next 2^x = 2</p><p>Partitioning: There is only one time range from all source blocks which means it is compacting level 1 blocks. Partitioning needs to include all source blocks in each partition.</p><p>Partitions in Partitioned Compaction Group:</p><ul><li>Partition ID: 0<br>Number of Partitions: 2<br>Blocks: B1, B2, B3</li><li>Partition ID: 1<br>Number of Partitions: 2<br>Blocks: B1, B2, B3</li></ul><hr><h4 id=scenario-all-source-blocks-are-with-compaction-level--1-and-were-generated-by-compactor-without-partitioning-compaction>Scenario: All source blocks are with compaction level > 1 and were generated by compactor without partitioning compaction</h4><p>If source block was generated by compactor without partitioning compaction, there should be only one block per time range. Since there is only one block in one time range, that one block would be included in all partitions.</p><pre tabindex=0><code>Time ranges:
T1, T2, T3

Source blocks:
T1: B1
T2: B2
T3: B3

Total indices size of all source blocks:
100G
</code></pre><p>Number of Partitions = (100G / 64G = 1.5625) => round up to next 2^x = 2</p><p>Partitioning:</p><ul><li>For T1, there is only one source block. Include B1 in all partitions.</li><li>For T2, there is only one source block. Include B2 in all partitions.</li><li>For T3, there is only one source block. Include B3 in all partitions.</li></ul><p>Partitions in Partitioned Compaction Group:</p><ul><li>Partition ID: 0<br>Number of Partitions: 2<br>Blocks: B1, B2, B3</li><li>Partition ID: 1<br>Number of Partitions: 2<br>Blocks: B1, B2, B3</li></ul><hr><h4 id=scenario-all-source-blocks-are-with-compaction-level--1-and-some-of-them-were-generated-by-compactor-with-partitioning-compaction>Scenario: All source blocks are with compaction level > 1 and some of them were generated by compactor with partitioning compaction</h4><p>Blocks generated by compactor without partitioning compaction would be included in all partitions. Blocks generated with partitioning compaction would be partitioned based on multiplier.</p><pre tabindex=0><code>Time ranges:
T1, T2, T3

Source blocks:
T1: B1 (unpartitioned)
T2: B2, B3
T3: B4, B5, B6, B7

Total indices size of all source blocks:
100G
</code></pre><p>Number of Partitions = (100G / 64G = 1.5625) => round up to next 2^x = 2</p><p>Partitioning:</p><ul><li>For T1, there is only one source block. Include B1 in all partitions.</li><li>For T2,<ul><li>B2 (index 0 in the time range) can be grouped with other blocks having N % 2 == 0.</li><li>B3 (index 1 in the time range) can be grouped with other blocks having N % 2 == 1.</li></ul></li><li>For T3,<ul><li>B4 (index 0 in the time range) can be grouped with other blocks having N % 2 == 0.</li><li>B5 (index 1 in the time range) can be grouped with other blocks having N % 2 == 1.</li><li>B6 (index 2 in the time range) can be grouped with other blocks having N % 2 == 0.</li><li>B7 (index 3 in the time range) can be grouped with other blocks having N % 2 == 1.</li></ul></li></ul><p>Partitions in Partitioned Compaction Group:</p><ul><li>Partition ID: 0<br>Number of Partitions: 2<br>Blocks: B1, B2, B4, B6</li><li>Partition ID: 1<br>Number of Partitions: 2<br>Blocks: B1, B3, B5, B7</li></ul></div></main></div></div><footer><div class="row td-box td-box--dark td-box--gradient td-box--height-auto text-white p-5"><div class="col-12 col-sm-4 pb-5 pb-sm-0"><img src=/images/cortex-stacked-white.png width=75px class="img-fluid float-left"></div><div class="col-12 col-sm-4 pb-5 pb-sm-0"><h6 class=font-weight-bold>Community</h6><ul class=list-unstyled><li><a href=https://slack.cncf.io class="text-reset text-white"><i class="fab fa-fw fa-slack"></i> Slack</a></li><li><a href=https://github.com/cortexproject/cortex class="text-reset text-white"><i class="fab fa-fw fa-github"></i> GitHub</a></li><li><a href=https://twitter.com/cortexmetrics class="text-reset text-white"><i class="fab fa-fw fa-twitter"></i> Twitter</a></li></ul></div><div class="col-12 col-sm-4"><h6 class=font-weight-bold>About</h6><p>Cortex is an OSS licensed project as Apache License 2.0</p></div></div><div class="row td-box td-box--dark td-box--gradient td-box--height-auto text-white p-5 text-center"><small class="col-12 text-center">© 2022 The Cortex Authors All Rights Reserved.<br>The Linux Foundation has registered trademarks and uses trademarks.
For a list of trademarks of The Linux Foundation, please see <a class="text-light alert-link" href=https://www.linuxfoundation.org/trademark-usage>Trademark Usage page</a>.</small></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA==" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script>
<script src=/js/main.min.91798a335c881f1b6b805085ba4aa22d1dbd2b0b18d105d05189fa104ddae350.js integrity="sha256-kXmKM1yIHxtrgFCFukqiLR29KwsY0QXQUYn6EE3a41A=" crossorigin=anonymous></script></body></html>