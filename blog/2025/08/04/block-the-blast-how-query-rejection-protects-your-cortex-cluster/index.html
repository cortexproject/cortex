<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.101.0"><meta name=robots content="index, follow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Block the Blast: How Query Rejection Protects Your Cortex Cluster | Cortex</title><meta name=description content="Query rejection gives Cortex operators a last-resort safety net against disruptive queries that bypass resource limits. Learn how it works, how to configure it, and best practices to protect your multi-tenant cluster.
"><meta property="og:title" content="Block the Blast: How Query Rejection Protects Your Cortex Cluster"><meta property="og:description" content="Query rejection gives Cortex operators a last-resort safety net against disruptive queries that bypass resource limits. Learn how it works, how to configure it, and best practices to protect your multi-tenant cluster.
"><meta property="og:type" content="article"><meta property="og:url" content="/blog/2025/08/04/block-the-blast-how-query-rejection-protects-your-cortex-cluster/"><meta property="og:image" content="/images/logo-twitter-card.jpg"><meta property="article:section" content="blog"><meta property="article:published_time" content="2025-08-04T00:00:00+00:00"><meta property="article:modified_time" content="2026-02-24T10:33:03+09:00"><meta property="og:site_name" content="Cortex"><meta itemprop=name content="Block the Blast: How Query Rejection Protects Your Cortex Cluster"><meta itemprop=description content="Query rejection gives Cortex operators a last-resort safety net against disruptive queries that bypass resource limits. Learn how it works, how to configure it, and best practices to protect your multi-tenant cluster.
"><meta itemprop=datePublished content="2025-08-04T00:00:00+00:00"><meta itemprop=dateModified content="2026-02-24T10:33:03+09:00"><meta itemprop=wordCount content="972"><meta itemprop=image content="/images/logo-twitter-card.jpg"><meta itemprop=keywords content="blog,cortex,query,rejection,"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/images/logo-twitter-card.jpg"><meta name=twitter:title content="Block the Blast: How Query Rejection Protects Your Cortex Cluster"><meta name=twitter:description content="Query rejection gives Cortex operators a last-resort safety net against disruptive queries that bypass resource limits. Learn how it works, how to configure it, and best practices to protect your multi-tenant cluster.
"><link rel=preload href=/scss/main.min.5eaade7cd2a503d4fabeefa845c4a82ed6faa89fe4c763572d9fbdd72b72312d.css as=style><link href=/scss/main.min.5eaade7cd2a503d4fabeefa845c4a82ed6faa89fe4c763572d9fbdd72b72312d.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SRR0DSREGX"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-SRR0DSREGX",{anonymize_ip:!1})}</script></head><body class="td-page td-blog"><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar navbar-nocover"><a id=cortex-logo class=navbar-brand href=/><span class=navbar-logo><svg xmlns="http://www.w3.org/2000/svg" role="img" viewBox="-17.92 -14.92 1191.84 462.84"><defs><style>.cls-1{fill:#fff}</style></defs><path d="M214.531 8.017C99.353 8.017 5.65 101.72 5.65 216.899S99.353 425.78 214.531 425.78s208.882-93.704 208.882-208.882S329.71 8.017 214.531 8.017zm0 408.558c-110.102.0-199.676-89.574-199.676-199.676S104.429 17.222 214.53 17.222 414.208 106.797 414.208 216.9 324.633 416.575 214.53 416.575z" class="cls-1"/><circle cx="327.452" cy="221.633" r="34.571" class="cls-1"/><circle cx="213.713" cy="353.584" r="34.571" class="cls-1"/><path d="M299.992 167.913l-59-56.05a34.578 34.578.0 10-4.343 4.34l57.828 54.937a60.158 60.158.0 00-27.168 49.123h-12.97l-23.456-67.02-26.055 64.718H175.73l-24.724 57.22-21.808-54.524-.063.025v-.586h-22.048a34.582 34.582.0 10-.275 6.138h18.005l25.97 64.925 28.977-67.06h29.207l21.51-53.424 19.503 55.725H267.5a60.173 60.173.0 0025.202 44.11l-56.52 56.52 4.34 4.338 57.492-57.492a60.155 60.155.0 101.977-105.963zm81.481 53.515a54.02 54.02.0 11-54.022-54.02 54.083 54.083.0 0154.022 54.02zm175.707 42.568q-8.797 8.178-24.405 8.177a34.858 34.858.0 01-17.095-3.965 33.188 33.188.0 01-11.643-10.529 46.374 46.374.0 01-6.566-14.99 71.134 71.134.0 01-2.105-17.341 86.99 86.99.0 011.982-18.706 46.804 46.804.0 016.565-15.98 34.028 34.028.0 0112.263-11.149q7.675-4.21 19.077-4.212 13.38.0 21.306 6.69 7.927 6.689 10.405 18.829h21.803a50.76 50.76.0 00-5.946-19.696 44.06 44.06.0 00-12.015-13.75 49.842 49.842.0 00-16.848-8.051 77.44 77.44.0 00-20.44-2.601q-15.114.0-26.509 5.326a52.935 52.935.0 00-18.952 14.617 62.165 62.165.0 00-11.273 21.8 94.013 94.013.0 00-3.717 26.883 86.195 86.195.0 003.84 26.386 57.783 57.783.0 0011.397 20.686 50.138 50.138.0 0018.829 13.38 66.766 66.766.0 0025.891 4.705q24.527.0 38.772-12.882 14.245-12.878 17.715-36.668h-21.556q-1.986 14.867-10.776 23.041zm157.44-87.828a56.338 56.338.0 00-19.447-14.244q-11.52-5.203-26.882-5.203-15.115.0-26.756 5.203a56.009 56.009.0 00-19.573 14.244 59.75 59.75.0 00-11.892 21.307 85.299 85.299.0 00-3.965 26.386 84.117 84.117.0 003.965 26.262 59.853 59.853.0 0011.892 21.183 54.61 54.61.0 0019.573 14.12q11.643 5.077 26.756 5.08 15.36.0 26.882-5.08a54.908 54.908.0 0019.447-14.12 59.95 59.95.0 0011.892-21.183 84.181 84.181.0 003.965-26.262 85.364 85.364.0 00-3.965-26.386 59.846 59.846.0 00-11.892-21.307zm-9.538 68.38a43.305 43.305.0 01-8.548 15.113 37.061 37.061.0 01-12.759 9.29 38.825 38.825.0 01-30.968.0 37.003 37.003.0 01-12.76-9.29 43.209 43.209.0 01-8.547-15.114 70.669 70.669.0 010-41.373 44.634 44.634.0 018.547-15.237 36.428 36.428.0 0112.76-9.415 38.826 38.826.0 0130.968.0 36.484 36.484.0 0112.76 9.415 44.735 44.735.0 018.547 15.237 70.624 70.624.0 010 41.373zm81.141-80.89q-11.147 7.434-18.83 23.041h-.493v-27.005h-19.82V287.78h21.057v-56.984a87.528 87.528.0 012.478-21.924 41.993 41.993.0 017.93-16.228 33.951 33.951.0 0114.368-10.158q8.919-3.468 21.555-3.468V156.72q-17.097-.493-28.245 6.937zm80.761-42.366h-21.06v38.402h-21.8v18.581h21.8v81.51a48.668 48.668.0 001.734 14.37 17.432 17.432.0 005.326 8.423 20.57 20.57.0 009.415 4.088 75.59 75.59.0 0013.999 1.115h16.104v-18.582h-9.664a70.335 70.335.0 01-8.05-.37 10.361 10.361.0 01-4.833-1.611 6.108 6.108.0 01-2.354-3.469 23.006 23.006.0 01-.617-5.946v-79.528h25.518v-18.581h-25.518zm148.522 60.452a56.135 56.135.0 00-18.085-17.962q-11.276-7.063-28.367-7.06a58.263 58.263.0 00-24.155 4.953A56.796 56.796.0 00925.82 175.55a63.949 63.949.0 00-12.51 21.058 77.064 77.064.0 00-4.461 26.758 102.521 102.521.0 004.338 27.004 58.87 58.87.0 0011.519 21.307 52.43 52.43.0 0018.953 13.873q11.272 4.954 26.632 4.955 21.8.0 36.173-10.901 14.364-10.898 18.58-32.455h-20.81q-2.73 12.635-11.272 18.829-8.549 6.198-21.927 6.195a43.577 43.577.0 01-18.085-3.468 35.417 35.417.0 01-12.636-9.291 36.127 36.127.0 01-7.184-13.38 50.746 50.746.0 01-1.981-15.98h95.879a102.07 102.07.0 00-2.107-24.526 71.064 71.064.0 00-9.415-23.784zm-84.357 29.73a43.81 43.81.0 013.219-13.999 37.354 37.354.0 017.433-11.52 34.013 34.013.0 0111.272-7.803 36.694 36.694.0 0114.74-2.85 36.062 36.062.0 0114.494 2.85 36.492 36.492.0 0111.398 7.68 36.107 36.107.0 017.68 11.52 43.253 43.253.0 013.345 14.122zm170.95 7.184 44.1-58.964h-25.271l-31.961 44.843-30.721-44.843h-27.006l44.595 60.698-48.063 67.389h25.518l35.677-53.019 35.676 53.019h27.006l-49.55-69.123z" class="cls-1"/></svg></span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs/><span>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/blog/><span class=active>Blog</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a href=https://twitter.com/cortexmetrics class="nav-link active"><span class=active><i class="fab fa-fw fa-twitter"></i> Twitter</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a href=https://github.com/cortexproject class="nav-link active"><span class=active><i class="fab fa-fw fa-github"></i> GitHub</span></a></li></ul></div><div class="navbar-nav d-none d-md-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.12dcd3afea02f6b977ad990aa468a60c.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><div id=content-mobile><form class="td-sidebar__search d-flex align-items-center"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.12dcd3afea02f6b977ad990aa468a60c.json data-offline-search-base-href=/ data-offline-search-max-results=10>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-section-nav aria-expanded=false aria-label="Toggle section navigation"></button></form></div><div id=content-desktop></div><nav class="collapse td-sidebar-nav" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-blog-li><a href=/blog/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-blog><span>Blog</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20251017introducing-readonly-state-gradual-and-safe-ingester-scaling-li><a href=/blog/2025/10/17/introducing-readonly-state-gradual-and-safe-ingester-scaling/ title="Introducing READONLY State: Gradual and Safe Ingester Scaling" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20251017introducing-readonly-state-gradual-and-safe-ingester-scaling><span>READONLY Ingester Scaling</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20250908query-priority-in-cortex-li><a href=/blog/2025/09/08/query-priority-in-cortex/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20250908query-priority-in-cortex><span>Query Priority in Cortex</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20250812efficient-query-parallelism-in-cortex-with-dynamic-query-splitting-li><a href=/blog/2025/08/12/efficient-query-parallelism-in-cortex-with-dynamic-query-splitting/ title="Efficient Query Parallelism in Cortex with Dynamic Query Splitting" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20250812efficient-query-parallelism-in-cortex-with-dynamic-query-splitting><span>Dynamic Query Splitting</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-blog20250804block-the-blast-how-query-rejection-protects-your-cortex-cluster-li><a href=/blog/2025/08/04/block-the-blast-how-query-rejection-protects-your-cortex-cluster/ title="Block the Blast: How Query Rejection Protects Your Cortex Cluster" class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-blog20250804block-the-blast-how-query-rejection-protects-your-cortex-cluster><span class=td-sidebar-nav-active-item>Query Rejection in Cortex</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20250429optimizing-promql-queries-a-deep-dive-li><a href=/blog/2025/04/29/optimizing-promql-queries-a-deep-dive/ title="Optimizing PromQL queries: A deep dive" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20250429optimizing-promql-queries-a-deep-dive><span>Optimizing PromQL queries</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20250426introducing-the-cortex-blog-sharing-our-journey-li><a href=/blog/2025/04/26/introducing-the-cortex-blog-sharing-our-journey/ title="Introducing the Cortex Blog: Sharing Our Journey" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20250426introducing-the-cortex-blog-sharing-our-journey><span>Hello Cortex!</span></a></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/cortexproject/cortex/edit/master/blog/2025/query-rejection.md target=_blank><i class="fa fa-edit fa-fw"></i> Edit this page</a>
<a href="https://github.com/cortexproject/cortex/issues/new?title=Block%20the%20Blast:%20How%20Query%20Rejection%20Protects%20Your%20Cortex%20Cluster" target=_blank><i class="fab fa-github fa-fw"></i> Create documentation issue</a>
<a href=https://github.com/cortexproject/cortex/issues/new target=_blank><i class="fas fa-tasks fa-fw"></i> Create project issue</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#why-limits-arent-enough>Why Limits Aren’t Enough</a></li><li><a href=#what-is-query-rejection>What Is Query Rejection?</a></li><li><a href=#matching-criteria>Matching Criteria</a></li><li><a href=#configuring-query-rejection>Configuring Query Rejection</a></li><li><a href=#practical-example>Practical Example</a></li><li><a href=#best-practices-and-cautions>Best Practices and Cautions</a></li><li><a href=#ruler-queries>Ruler Queries</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div><div class="taxonomy taxonomy-terms-cloud taxo-projects"><h5 class=taxonomy-title>Our Projects</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=/projects/cortex/ data-taxonomy-term=cortex><span class=taxonomy-label>cortex</span><span class=taxonomy-count>6</span></a></li></ul></div><div class="taxonomy taxonomy-terms-cloud taxo-tags"><h5 class=taxonomy-title>Tag Cloud</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=/tags/blog/ data-taxonomy-term=blog><span class=taxonomy-label>blog</span><span class=taxonomy-count>6</span></a></li><li><a class=taxonomy-term href=/tags/community/ data-taxonomy-term=community><span class=taxonomy-label>community</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=/tags/cortex/ data-taxonomy-term=cortex><span class=taxonomy-label>cortex</span><span class=taxonomy-count>6</span></a></li><li><a class=taxonomy-term href=/tags/ingester/ data-taxonomy-term=ingester><span class=taxonomy-label>ingester</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=/tags/optimization/ data-taxonomy-term=optimization><span class=taxonomy-label>optimization</span><span class=taxonomy-count>3</span></a></li><li><a class=taxonomy-term href=/tags/query/ data-taxonomy-term=query><span class=taxonomy-label>query</span><span class=taxonomy-count>4</span></a></li><li><a class=taxonomy-term href=/tags/rejection/ data-taxonomy-term=rejection><span class=taxonomy-label>rejection</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=/tags/scaling/ data-taxonomy-term=scaling><span class=taxonomy-label>scaling</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=/tags/updates/ data-taxonomy-term=updates><span class=taxonomy-label>updates</span><span class=taxonomy-count>1</span></a></li></ul></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role=main><a class="btn btn-lg -bg-orange td-rss-button d-none d-lg-block" href=/blog/index.xml target=_blank>RSS <i class="fa fa-rss ml-2"></i></a><div class=td-content><h1>Block the Blast: How Query Rejection Protects Your Cortex Cluster</h1><div class=lead>Query rejection gives Cortex operators a last-resort safety net against disruptive queries that bypass resource limits. Learn how it works, how to configure it, and best practices to protect your multi-tenant cluster.</div><div class="td-byline mb-4">By <b>Erlan Zholdubai uulu (<a href=https://github.com/erlan-z>@erlan-z</a>)</b> |
<time datetime=2025-08-04 class=text-muted>Monday, August 04, 2025</time></div><header class=article-meta><div class="taxonomy taxonomy-terms-article taxo-tags"><h5 class=taxonomy-title>Tags:</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=/tags/blog/ data-taxonomy-term=blog><span class=taxonomy-label>blog</span></a></li><li><a class=taxonomy-term href=/tags/cortex/ data-taxonomy-term=cortex><span class=taxonomy-label>cortex</span></a></li><li><a class=taxonomy-term href=/tags/query/ data-taxonomy-term=query><span class=taxonomy-label>query</span></a></li><li><a class=taxonomy-term href=/tags/rejection/ data-taxonomy-term=rejection><span class=taxonomy-label>rejection</span></a></li></ul></div><div class="taxonomy taxonomy-terms-article taxo-categories"><h5 class=taxonomy-title>Categories:</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=/categories/blog/ data-taxonomy-term=blog><span class=taxonomy-label>blog</span></a></li></ul></div></header><h1 id=introduction>Introduction</h1><p>Although Cortex includes various safeguards to protect against overload, they can’t prevent every failure scenario. In some environments, a small set of seemingly harmless-looking dashboard queries have repeatedly slipped just under the limits yet still OOM-killed the querier pods. Built-in protections weren’t enough, and the only available option was to throttle all incoming traffic. These queries often came from a specific dashboard or followed a predictable pattern. There was no way to block just those without affecting everything else. This inspired the introduction of query rejection, a last-resort safety net for operators running multi-tenant Cortex clusters.</p><h2 id=why-limits-arent-enough>Why Limits Aren’t Enough</h2><p>Cortex already includes resource limiting, throttling and other resource safeguards, but these protections can’t cover every edge case. Some limits are enforced too late in the query lifecycle to matter; others are broad and can’t target specific bad actors. As a result, a single heavy query can bypass all service limits and still:</p><ul><li>Cause OOM kills that disrupt other tenants.</li><li>Degrade availability or spike latency for everyone.</li><li>Require manual operator intervention to restore normal service.</li></ul><p>We needed a more precise tool—one that lets operators proactively block specific query patterns without harming legitimate traffic.</p><h2 id=what-is-query-rejection>What Is Query Rejection?</h2><p>Think of query rejection as an “emergency stop” in a factory. It sits in front of the query engine and checks each request against a set of operator-defined rules. If a request matches criteria, it’s rejected immediately. This allows you to target the handful of queries that cause trouble without imposing a blanket slowdown on everyone else.</p><p><strong>Key features:</strong></p><ul><li><strong>Per-tenant control:</strong> It&rsquo;s defined in the tenant limit configuration, which only targets queries from specific tenant.</li><li><strong>Precise matching:</strong> You can specify different query attributes to narrow down to specific queries. All fields within a rejection rule must match (AND logic). If needed, you can define multiple independent rejection rules to target different types of queries.</li><li><strong>Pre-processing enforcement:</strong> Query rejection is applied before the query is executed, allowing known-bad patterns to be blocked before consuming any resources.</li></ul><h2 id=matching-criteria>Matching Criteria</h2><p>Heavy queries often share identifiable traits. Query rejection lets you match on a variety of attributes and reject only those requests. You can combine as many of these as needed:</p><ul><li><strong>API type:</strong> <code>query</code>, <code>query_range</code>, <code>series</code>, etc.</li><li><strong>Query string (regex):</strong> Match by pattern, e.g., any query containing “ALERT”.</li><li><strong>Time range:</strong> Match queries whose range falls between a configured <strong>min</strong> and <strong>max</strong>.</li><li><strong>Time window:</strong> Match queries based on how far their time window is from now by specifying relative <strong>min</strong> and <strong>max</strong> boundaries. This is often used to distinguish queries that hit hot storage versus cold storage.</li><li><strong>Step value (resolution):</strong> Block extremely fine resolutions (e.g., steps under 5s).</li><li><strong>Headers:</strong> Match by User-Agent, Grafana dashboard UID (<code>X-Dashboard-Uid</code>) or panel ID (<code>X-Panel-Id</code>).</li></ul><p>By combining these fields, you can zero in on the exact query patterns causing problems without over-blocking.</p><h2 id=configuring-query-rejection>Configuring Query Rejection</h2><p>You define query rejection rules per tenant in a runtime config file. Each rejection rule specifies a set of attributes that must all match for the query to be rejected. The configuration supports multiple such rules.</p><p>Here’s an example configuration:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># runtime_config.yaml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>overrides</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;tenant_id&gt;</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>query_rejection</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>query_attributes</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>api_type</span>: <span style=color:#ae81ff>query_range</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>regex</span>: <span style=color:#ae81ff>.*ALERT.*</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>query_step_limit</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>min</span>: <span style=color:#ae81ff>6s</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>max</span>: <span style=color:#ae81ff>20s</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>dashboard_uid</span>: <span style=color:#e6db74>&#34;dash123&#34;</span>
</span></span></code></pre></div><p><strong>What this does:</strong></p><ul><li><code>enabled</code> This allows you to temporarily turn off query rejection without removing the configuration. It can help verify whether previously blocked queries are still causing issues.</li><li><code>query_attributes</code> is a list of rejection rules. A query will only be rejected if it matches all attributes within one rejection rule.</li></ul><p>In the example above, the single rejection rule requires the following:</p><ul><li>API type must be <code>query_range</code>.</li><li>The query string must contain the word <code>ALERT</code>.</li><li>The step must be between 6 and 20 seconds.</li><li>The request must come from a dashboard with UID <code>dash123</code>.</li></ul><p>If all of these conditions match, the request is rejected with a <code>422</code> response. If even one condition doesn’t match, the query is allowed to run. You can define additional rejection rules in the list to target different patterns.</p><h2 id=practical-example>Practical Example</h2><p>Imagine a dashboard panel that repeatedly hits your cluster with a query like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  <span style=color:#e6db74>&#39;http://localhost:8005/prometheus/api/v1/query?query=customALERTquery&amp;start=1718383304&amp;end=1718386904&amp;step=7s&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -H <span style=color:#e6db74>&#34;User-Agent: other&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -H <span style=color:#e6db74>&#34;X-Dashboard-Uid: dash123&#34;</span>
</span></span></code></pre></div><p>Because this request matches all the configured attributes, it will be blocked. But if even one field is different—such as a longer step duration or a different dashboard UID—the query will go through.</p><h2 id=best-practices-and-cautions>Best Practices and Cautions</h2><ul><li><p><strong>Start with narrow rules.</strong> Use the most specific fields first—like panel ID or dashboard UID—to reduce risk of over-blocking.</p></li><li><p><strong>Monitor rejections.</strong> Use the <code>cortex_query_frontend_rejected_queries_total</code> metric to track rejected queries, and check logs for detailed query information.</p></li><li><p><strong>Communicate with tenants.</strong> Let affected tenants know if their queries are being blocked, and help them adjust their dashboards accordingly.</p></li></ul><h2 id=ruler-queries>Ruler Queries</h2><p>Query rejection only applies to API queries and does not apply to ruler queries. However, Ruler queries are typically instant and lightweight, so a complex query‑rejection mechanism isn’t required for them.
In situations where a rule group contains heavy queries and no other mitigations are effective, operators can disable the entire rule group. This is especially helpful to prevent Rulers from getting OOMKilled due to resource-intensive rules.</p><p>Rule group disabling is configured per tenant, similar to query rejection. When you disable a rule group, Cortex stops evaluating the rules within that group, removing the problematic queries altogether. For example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># runtime_config.yaml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>overrides</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;tenant_id&gt;</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>disabled_rule_groups</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>namespace</span>: <span style=color:#e6db74>&#34;keep_firing_for_test&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;smallsteps&#34;</span>
</span></span></code></pre></div><p>This makes it easy to mitigate issues from the ruler without introducing query rejection logic for those queries.</p><h2 id=conclusion>Conclusion</h2><p>When traditional safeguards fall short, query rejection gives operators precise control to block only what’s harmful; without slowing down everything else.</p><p>If you operate a shared Cortex environment, consider learning how to use query rejection effectively. It might just save you from the next incident; by preventing OOM kills, degraded performance, or disruption to other tenants.</p><ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5"><li><a href=/blog/2025/04/29/optimizing-promql-queries-a-deep-dive/ aria-label="Previous - Optimizing PromQL queries: A deep dive" class="btn btn-primary"><span class=mr-1>←</span>Previous</a></li><a href=/blog/2025/08/12/efficient-query-parallelism-in-cortex-with-dynamic-query-splitting/ aria-label="Next - Efficient Query Parallelism in Cortex with Dynamic Query Splitting" class="btn btn-primary">Next<span class=ml-1>→</span></a></li></ul></div></main></div></div><footer><div class="row td-box td-box--dark td-box--gradient td-box--height-auto text-white p-5"><div class="col-12 col-sm-4 pb-5 pb-sm-0"><img src=/images/cortex-stacked-white.png width=75px class="img-fluid float-left"></div><div class="col-12 col-sm-4 pb-5 pb-sm-0"><h6 class=font-weight-bold>Community</h6><ul class=list-unstyled><li><a href=https://slack.cncf.io class="text-reset text-white"><i class="fab fa-fw fa-slack"></i> Slack</a></li><li><a href=https://github.com/cortexproject/cortex class="text-reset text-white"><i class="fab fa-fw fa-github"></i> GitHub</a></li><li><a href=https://twitter.com/cortexmetrics class="text-reset text-white"><i class="fab fa-fw fa-twitter"></i> Twitter</a></li></ul></div><div class="col-12 col-sm-4"><h6 class=font-weight-bold>About</h6><p>Cortex is an OSS licensed project as Apache License 2.0</p></div></div><div class="row td-box td-box--dark td-box--gradient td-box--height-auto text-white p-5 text-center"><small class="col-12 text-center">© 2025 The Cortex Authors All Rights Reserved.<br>The Linux Foundation has registered trademarks and uses trademarks.
For a list of trademarks of The Linux Foundation, please see <a class="text-light alert-link" href=https://www.linuxfoundation.org/trademark-usage>Trademark Usage page</a>.</small></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA==" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script>
<script src=/js/main.min.91798a335c881f1b6b805085ba4aa22d1dbd2b0b18d105d05189fa104ddae350.js integrity="sha256-kXmKM1yIHxtrgFCFukqiLR29KwsY0QXQUYn6EE3a41A=" crossorigin=anonymous></script></body></html>